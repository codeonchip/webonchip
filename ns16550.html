<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NS16550(A) UART Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --line:#223047; --accent:#38bdf8; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: ui-monospace, Menlo, Consolas, monospace; background:linear-gradient(180deg,#0b1220 0,#08101f 100%); color:var(--ink); }
  header { display:flex; align-items:center; gap:16px; padding:14px 16px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(11,18,32,.9); backdrop-filter: blur(6px); }
  header h1 { margin:0; font-size:16px; letter-spacing:.4px; color:#dbeafe; }
  main { padding:16px; display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; }
  @media (max-width:1100px){ main{ grid-template-columns:1fr; } }
  .card { background:var(--panel); border:1px solid var(--line); border-radius:12px; overflow:hidden; }
  .card h2 { margin:0; padding:10px 12px; border-bottom:1px solid var(--line); font-size:14px; color:#cbd5e1; }
  .body { padding:12px; }
  .grid { display:grid; grid-template-columns: repeat(2,1fr); gap:16px; }
  @media (max-width:1600px){ .grid{ grid-template-columns:1fr; } }
  table { width:100%; border-collapse: collapse; font-size:12px; }
  th, td { border-bottom:1px dashed #1d2a3f; padding:6px 8px; text-align:left; color:#d1d5db; }
  th { color:#93c5fd; }
  input, button, select { background:#0b1220; color:var(--ink); border:1px solid var(--line); border-radius:8px; padding:6px 8px; }
  button { cursor:pointer; }
  button.primary { border-color: var(--accent); color:#e0f2fe; }
  button.ok { border-color: var(--ok); color:#dcfce7; }
  button.warn { border-color: var(--warn); color:#fffbeb; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .tiny { font-size:11px; color:var(--muted); }
  .kbd { border:1px solid var(--line); padding:2px 6px; border-radius:6px; background:#0b1220; }
  .pill { display:inline-block; padding:2px 6px; border:1px solid var(--line); border-radius:999px; font-size:11px; }
  .led { display:inline-block; width:10px; height:10px; border-radius:50%; border:1px solid #0004; margin-left:6px; }
  .led.on { background:#22c55e; }
  .term { background:#030914; border:1px solid var(--line); border-radius:8px; min-height:200px; padding:10px; white-space:pre-wrap; overflow:auto; }
  textarea { width:100%; min-height:80px; }
  code { background:#0b1220; padding:2px 6px; border-radius:6px; color:#93c5fd; }
</style>
</head>
<body>
<header>
  <h1>NS16550(A) UART Simulator</h1>
  <div class="row">
    <span class="tiny">Tick (baud steps/s)</span>
    <input id="hz" type="number" value="30" min="1" max="1000" style="width:90px" />
    <button id="runBtn" class="primary">Run</button>
    <button id="stepBtn">Step</button>
    <button id="pauseBtn" class="warn">Pause</button>
    <span class="tiny">Tick:</span><span id="tickLbl" class="kbd">0</span>
    <span class="tiny">IRQ:</span><span id="irqLed" class="led"></span>
  </div>
</header>

<main>
  <section class="card">
    <h2>CPU View — Registers & FIFOs</h2>
    <div class="body">
      <div class="row" style="margin-bottom:8px">
        <button id="initBtn" class="ok">Init 115200 8N1 + FIFO</button>
        <span class="tiny">Clock:</span>
        <input id="clkHz" type="number" value="1843200" min="1" style="width:120px" title="Input clock Hz (e.g., 1.8432 MHz)" />
        <span class="tiny">Baud (calc)</span><span id="baudLbl" class="kbd">?</span>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Registers (offsets 0..7)</h2>
          <div class="body">
            <table>
              <thead><tr><th>Addr</th><th>Name (DLAB=0)</th><th>Name (DLAB=1)</th><th>Value (hex)</th><th>Actions</th></tr></thead>
              <tbody id="regRows"></tbody>
            </table>
            <div class="tiny" style="margin-top:6px">
              LCR bit7 = DLAB. Offs 0/1 map to THR/RBR & IER when DLAB=0, or DLL/DLM when DLAB=1.
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Status & Control</h2>
          <div class="body">
            <table>
              <tbody>
                <tr><th>LCR</th><td id="lcrBits">—</td></tr>
                <tr><th>MCR</th><td id="mcrBits">—</td></tr>
                <tr><th>LSR</th><td id="lsrBits">—</td></tr>
                <tr><th>IIR</th><td id="iirBits">—</td></tr>
                <tr><th>IER</th><td id="ierBits">—</td></tr>
              </tbody>
            </table>
            <div class="tiny" style="margin-top:6px">
              <b>LSR:</b> DR(0) OE(1) PE(2) FE(3) BI(4) THRE(5) TEMT(6) FIFO(7)<br/>
              <b>IIR:</b> bit0=~INT; bits3:1 reason; bits7:6 FIFO exist/enabled
            </div>
          </div>
        </div>

        <div class="card">
          <h2>FIFOs</h2>
          <div class="body">
            <div class="row">
              <div><b>TX FIFO</b> (<span id="txCount">0</span>/16)</div>
              <button id="clrTx">Clear TX</button>
            </div>
            <div id="txFifoView" class="tiny" style="margin-top:6px"></div>
            <hr style="border-color:#1d2a3f" />
            <div class="row">
              <div><b>RX FIFO</b> (<span id="rxCount">0</span>/16)</div>
              <button id="clrRx">Clear RX</button>
            </div>
            <div id="rxFifoView" class="tiny" style="margin-top:6px"></div>
          </div>
        </div>

        <div class="card">
          <h2>Terminal (TX out) & RX feed</h2>
          <div class="body">
            <div class="term" id="termOut"></div>
            <div class="row" style="margin-top:8px">
              <input id="txString" placeholder="Send string via THR (CPU write)" style="flex:1" />
              <button id="sendBtn">Send</button>
            </div>
            <div class="row" style="margin-top:8px">
              <input id="rxFeed" placeholder="Type host->UART RX data" style="flex:1" />
              <button id="feedBtn">Feed RX</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tiny" style="margin-top:8px">
        Tips: Write LCR=0x80 to set DLAB, then program DLL/DLM, then LCR=0x03 (8N1). Enable FIFO with FCR=0xC7. Set MCR OUT2 for IRQ delivery.
      </div>
    </div>
  </section>

  <section class="card">
    <h2>I/O Log</h2>
    <div class="body">
      <textarea id="log" spellcheck="false"></textarea>
    </div>
  </section>
</main>

<script>
/* ===================== 16550 State ===================== */
const U = {
  // Registers (8 offsets). We store raw byte values; access logic handles DLAB.
  R: new Uint8Array(8),
  // Internal named views
  get LCR(){ return U.R[3]; }, set LCR(v){ U.R[3]=v&0xFF; },
  get MCR(){ return U.R[4]; }, set MCR(v){ U.R[4]=v&0xFF; },
  get LSR(){ return U.R[5]; }, set LSR(v){ U.R[5]=v&0xFF; },
  get MSR(){ return U.R[6]; }, set MSR(v){ U.R[6]=v&0xFF; },
  get SCR(){ return U.R[7]; }, set SCR(v){ U.R[7]=v&0xFF; },

  // FIFOs and shifter
  txFifo: [],
  rxFifo: [],
  shifterBusy: false,   // simplifed transmitter shift register
  fifoEnabled: false,   // mirrors FCR bit0
  rxTrigger: 1,         // trigger level from FCR bits7:6 (1,4,8,14)
  // Interrupt / timing
  IER: 0, IIR: 0x01,    // IIR bit0=1 -> no interrupt
  tick: 0,
  // Input clock & baud
  clkHz: 1843200,
  get divisor(){ const dll = U.DLAB? U.R[0]:U.DLLshadow; return (U.DLAB? ((U.R[1]<<8)|U.R[0]) : U.DLLshadow| (U.DLMshadow<<8)); },
  DLLshadow: 1, DLMshadow: 0, // keep latches for baud display even when DLAB toggles
  get DLAB(){ return (U.LCR>>7)&1; },

  // IRQ line (depends on IER & MCR.OUT2)
  IRQ: false,
};

const IIR_REASON = {
  MODEM: 0x00,  // (not used here)
  THRE:  0x02,
  RXAV:  0x04,
  RXLS:  0x06,  // line status
  TIMEOUT:0x0C
};

/* ===================== Helpers / UI ===================== */
const logEl = document.getElementById('log');
function log(s){ logEl.value += s + "\n"; logEl.scrollTop = logEl.scrollHeight; }
function hex2(v){ return (v&0xFF).toString(16).padStart(2,'0').toUpperCase(); }
function bit(v,n){ return (v>>n)&1; }
const term = document.getElementById('termOut');
function termPut(ch){ term.textContent += ch; term.scrollTop = term.scrollHeight; }

function calcBaud(){
  const div = ((U.DLMshadow<<8) | U.DLLshadow) || 1;
  const baud = Math.floor(U.clkHz / (16 * div));
  return baud;
}

/* ===================== Register access (CPU mmio) ===================== */
function cpuWrite(offset, val){
  val &= 0xFF;
  const dlab = U.DLAB;
  switch(offset & 7){
    case 0: // THR or DLL
      if(dlab){
        U.R[0]=val; U.DLLshadow=val;      // DLL
        log(`W DLL=${hex2(val)}`);
      }else{
        // THR write -> enqueue to TX FIFO/holding
        pushTx(val);
        log(`W THR='${ printable(val) }' (${hex2(val)})`);
        // THRE becomes 0 immediately; will become 1 when holding empty
        updateStatus();
      }
      break;
    case 1: // IER or DLM
      if(dlab){ U.R[1]=val; U.DLMshadow=val; log(`W DLM=${hex2(val)}`); }
      else { U.IER = val & 0x0F; U.R[1]=U.IER; log(`W IER=${hex2(U.IER)}`); }
      break;
    case 2: // FCR (write) / IIR (read only)
      // Writing here is FCR
      const oldFifo = U.fifoEnabled;
      const enable = bit(val,0);
      U.fifoEnabled = !!enable;
      if(bit(val,1)){ U.rxFifo.length = 0; } // clear RX
      if(bit(val,2)){ U.txFifo.length = 0; } // clear TX
      // RX trigger bits 7:6
      const trigSel = (val>>6)&3; U.rxTrigger = [1,4,8,14][trigSel];
      if(enable && !oldFifo){ log(`FIFOs enabled; RX trigger=${U.rxTrigger}`); }
      if(!enable && oldFifo){ log(`FIFOs disabled`); }
      // Set FIFO status bits in IIR (bits7:6): 11 when enabled on 16550A+
      setIIRNoInt(); // reason recalculated below
      break;
    case 3: // LCR
      U.LCR = val;
      log(`W LCR=${hex2(val)} DLAB=${bit(val,7)} WLEN=${(val&3)+5} STOP=${bit(val,2)?2:1} PAR=${(val>>3)&7}`);
      break;
    case 4: // MCR
      U.MCR = val & 0x1F; // we only keep lower 5 bits
      log(`W MCR=${hex2(U.MCR)} (OUT2=${bit(U.MCR,3)})`);
      break;
    case 5: // LSR is read-only (ignoring for writes)
      log(`W LSR (ignored)`);
      break;
    case 6: // MSR (write ignored)
      log(`W MSR (ignored)`);
      break;
    case 7: // SCR
      U.SCR = val; log(`W SCR=${hex2(val)}`);
      break;
  }
  updateStatus();
}
function cpuRead(offset){
  let val = 0xFF;
  const dlab = U.DLAB;
  switch(offset & 7){
    case 0: // RBR or DLL
      if(dlab){ val = U.R[0]; log(`R DLL=${hex2(val)}`); }
      else {
        val = popRx();
        log(`R RBR='${ printable(val) }' (${hex2(val)})`);
      }
      break;
    case 1: // IER or DLM
      if(dlab){ val = U.R[1]; log(`R DLM=${hex2(val)}`); }
      else { val = U.IER; log(`R IER=${hex2(val)}`); }
      break;
    case 2: // IIR (read)
      val = U.IIR;
      log(`R IIR=${hex2(val)}`);
      // Reading IIR does not clear the source; driver must service it.
      break;
    case 3: val = U.LCR; log(`R LCR=${hex2(val)}`); break;
    case 4: val = U.MCR; log(`R MCR=${hex2(val)}`); break;
    case 5: val = U.LSR; log(`R LSR=${hex2(val)}`); break;
    case 6: val = U.MSR; log(`R MSR=${hex2(val)}`); break;
    case 7: val = U.SCR; log(`R SCR=${hex2(val)}`); break;
  }
  return val & 0xFF;
}

/* ===================== FIFO / LSR / IIR mechanics ===================== */
function printable(b){ const c=b&0x7F; if(c<32 || c===127) return '.'; return String.fromCharCode(c); }

function pushTx(b){
  if(U.fifoEnabled){
    if(U.txFifo.length<16) U.txFifo.push(b);
  }else{
    // emulate holding register: length 0 or 1
    if(U.txFifo.length===0) U.txFifo.push(b);
  }
}

function popRx(){
  let v = 0x00;
  if(U.fifoEnabled){
    v = (U.rxFifo.length? U.rxFifo.shift() : 0);
  }else{
    v = (U.rxFifo.length? U.rxFifo.shift() : 0);
  }
  updateStatus();
  return v;
}

function setIIRNoInt(){
  // Base: bit0=1 means no interrupt pending. Bits7:6 indicate FIFO.
  let iir = 0x01;
  if(U.fifoEnabled) iir |= 0xC0; // 16550A: 11 means FIFO enabled/present
  U.IIR = iir;
}

function recomputeIIR(){
  // Priority (simplified): RX line status > RX data avail > THRE > modem
  // We only implement RX avail + THRE here.
  setIIRNoInt();
  const dr = bit(U.LSR,0);
  const thre = bit(U.LSR,5);
  // Only assert IRQ if enabled and OUT2 set
  const irqGate = bit(U.MCR,3); // OUT2
  let reason = null;
  if(dr && (U.IER & 0x01)) reason = IIR_REASON.RXAV;
  else if(thre && (U.IER & 0x02)) reason = IIR_REASON.THRE;
  if(reason!=null && irqGate){
    U.IIR = (U.IIR & 0xC0) | reason; // keep FIFO bits
    U.IIR &= ~0x01; // bit0=0 -> interrupt pending
    U.IRQ = true;
  }else{
    U.IRQ = false;
  }
}

function updateStatus(){
  // LSR bits:
  // 0 DR: set if RX FIFO (or holding) has data
  // 5 THRE: TX holding empty
  // 6 TEMT: transmitter empty (holding + shift)
  const rxHas = U.rxFifo.length>0;
  let lsr = U.LSR;
  lsr = (lsr & 0x60) | 0; // we'll rebuild DR/THRE/TEMT fresh; clear 0/5/6
  if(rxHas) lsr |= 1<<0;
  const holdingEmpty = U.txFifo.length===0;
  if(holdingEmpty) lsr |= 1<<5;
  if(holdingEmpty && !U.shifterBusy) lsr |= 1<<6;
  U.LSR = lsr & 0xFF;
  recomputeIIR();
  render();
}

/* ===================== Tick / Transmit engine ===================== */
let timer=null;
function stepTick(){
  U.tick++;
  document.getElementById('tickLbl').textContent = U.tick;

  // Move one byte from holding/FIFO to shifter, then out on next half-step (simplified)
  if(!U.shifterBusy && U.txFifo.length){
    U.shifterBusy = true;
    const b = U.txFifo.shift();
    // Simulate serialization delay by output on next iteration:
    setTimeout(()=>{ termPut(String.fromCharCode(b)); U.shifterBusy=false; updateStatus(); }, 0);
  }

  updateStatus(); // also handles IIR/IRQ
}

function runClock(){
  if(timer) return;
  const hz = Math.max(1, Math.min(1000, Number(document.getElementById('hz').value)||30));
  timer = setInterval(stepTick, 1000/hz);
}
function pauseClock(){ clearInterval(timer); timer=null; }

/* ===================== UI: register table ===================== */
const regRows = document.getElementById('regRows');
const regNames0 = ['RBR/THR','IER','IIR/R(FCR)','LCR','MCR','LSR','MSR','SCR'];
const regNames1 = ['DLL','DLM','IIR/W(FCR)','LCR','MCR','LSR','MSR','SCR'];

function makeRow(i){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>0x0${i}</td>
    <td>${regNames0[i]}</td>
    <td>${regNames1[i]}</td>
    <td><input id="reg${i}" value="00" size="4" /></td>
    <td class="row">
      <button data-r="${i}" data-op="read">Read</button>
      <button data-r="${i}" data-op="write">Write</button>
    </td>
  `;
  return tr;
}
for(let i=0;i<8;i++) regRows.appendChild(makeRow(i));

regRows.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  const idx = Number(b.dataset.r), op = b.dataset.op;
  const inp = document.getElementById('reg'+idx);
  if(op==='read'){
    const v = cpuRead(idx);
    inp.value = hex2(v);
  }else{
    const v = parseInt(inp.value,16) & 0xFF;
    cpuWrite(idx, v);
    inp.value = hex2(v);
  }
});

/* ===================== UI bindings ===================== */
document.getElementById('initBtn').addEventListener('click', ()=>{
  // Typical PC init: 115200 at 1.8432 MHz -> divisor=1
  const clk = Number(document.getElementById('clkHz').value)||1843200;
  U.clkHz = clk;
  cpuWrite(3, 0x80);     // LCR DLAB=1
  cpuWrite(0, 0x01);     // DLL=1
  cpuWrite(1, 0x00);     // DLM=0
  cpuWrite(3, 0x03);     // LCR 8N1
  cpuWrite(2, 0xC7);     // FCR enable FIFOs, clear, trigger 14
  cpuWrite(4, 0x0B);     // MCR DTR|RTS|OUT2
  // Enable RX + THRE interrupts
  cpuWrite(1, 0x03);     // IER RX|THRE
  render();
});

document.getElementById('sendBtn').addEventListener('click', ()=>{
  const s = document.getElementById('txString').value || '';
  for(const ch of s){ cpuWrite(0, ch.charCodeAt(0)); }
  render();
});

document.getElementById('feedBtn').addEventListener('click', ()=>{
  const s = document.getElementById('rxFeed').value || '';
  for(const ch of s){
    if(U.fifoEnabled){
      if(U.rxFifo.length<16) U.rxFifo.push(ch.charCodeAt(0)&0xFF);
    }else{
      if(U.rxFifo.length===0) U.rxFifo.push(ch.charCodeAt(0)&0xFF);
    }
  }
  updateStatus();
});

document.getElementById('clrTx').addEventListener('click', ()=>{ U.txFifo.length=0; updateStatus(); });
document.getElementById('clrRx').addEventListener('click', ()=>{ U.rxFifo.length=0; updateStatus(); });

document.getElementById('runBtn').addEventListener('click', runClock);
document.getElementById('pauseBtn').addEventListener('click', pauseClock);
document.getElementById('stepBtn').addEventListener('click', stepTick);

document.getElementById('clkHz').addEventListener('change', ()=>{ U.clkHz = Number(document.getElementById('clkHz').value)||1843200; render(); });

/* ===================== Render ===================== */
function render(){
  // Register inputs reflect current values
  for(let i=0;i<8;i++){
    let show = U.R[i];
    if(i===0 && !U.DLAB) show = (U.txFifo.length? U.txFifo[0] : 0x00); // THR preview (not real HW)
    if(i===1 && !U.DLAB) show = U.IER;
    if(i===2) show = U.IIR; // reads as IIR
    document.getElementById('reg'+i).value = hex2(show);
  }

  // Status bitfields
  const lcr = U.LCR, mcr = U.MCR, lsr = U.LSR, iir = U.IIR, ier = U.IER;
  document.getElementById('lcrBits').innerHTML =
    `DLAB=${bit(lcr,7)} | WLEN=${(lcr&3)+5} | STOP=${bit(lcr,2)?2:1} | PAR=${(lcr>>3)&7}`;
  document.getElementById('mcrBits').innerHTML =
    `DTR=${bit(mcr,0)} RTS=${bit(mcr,1)} OUT1=${bit(mcr,2)} OUT2=${bit(mcr,3)} LOOP=${bit(mcr,4)}`;
  document.getElementById('lsrBits').innerHTML =
    `DR=${bit(lsr,0)} THRE=${bit(lsr,5)} TEMT=${bit(lsr,6)}`;
  const reason = (iir & 0x01)? 'NOINT' :
     ((iir>>1)&7)===0x02 ? 'THRE' :
     ((iir>>1)&7)===0x04 ? 'RXAV' :
     ((iir>>1)&7)===0x06 ? 'RXLS' :
     ((iir>>1)&7)===0x00 ? 'MODEM' : 'TIMEOUT';
  document.getElementById('iirBits').innerHTML =
    `pend=${bit(iir,0)?0:1} reason=${reason} | FIFO=${(iir>>6)&3}`;
  document.getElementById('ierBits').textContent =
    `ERBFI=${bit(ier,0)} ETBEI=${bit(ier,1)} ELSI=${bit(ier,2)} EDSSI=${bit(ier,3)}`;

  // FIFO views
  document.getElementById('txCount').textContent = U.txFifo.length;
  document.getElementById('rxCount').textContent = U.rxFifo.length;
  document.getElementById('txFifoView').textContent =
    '[' + U.txFifo.map(b=>hex2(b)).join(' ') + ']';
  document.getElementById('rxFifoView').textContent =
    '[' + U.rxFifo.map(b=>hex2(b)).join(' ') + ']';

  // IRQ LED
  const led = document.getElementById('irqLed');
  if(U.IRQ) led.classList.add('on'); else led.classList.remove('on');

  // Baud label
  document.getElementById('baudLbl').textContent = calcBaud();
}

/* ===================== Boot ===================== */
function boot(){
  // Power-on defaults
  U.R.fill(0);
  U.IER = 0; U.R[1]=0;
  U.LCR = 0x00;
  U.MCR = 0x00;
  U.LSR = 0x60; // THRE|TEMT set at reset
  setIIRNoInt();
  render();
  log('NS16550(A) simulator ready.');
}
boot();
</script>
</body>
</html>
