<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>J1939 CAN ID → PGN Converter</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#9CA3AF; --fg:#E5E7EB; --accent:#60A5FA; --ok:#34D399; }
  * { box-sizing: border-box; }
  html, body { margin:0; height:100%; font-family: ui-sans-serif, system-ui; background: var(--bg); color: var(--fg); }
  header { padding:24px 18px; text-align:center; border-bottom: 1px solid #1f2937; background:#0b1224; }
  h1 { margin:0; font-weight:800; }
  h1 small { display:block; font-weight:500; color:var(--muted); margin-top:6px; }
  main { padding:24px; max-width:800px; margin:0 auto; }
  .card { background: var(--card); border:1px solid #1f2937; border-radius:14px; padding:16px; margin-bottom:16px; }
  .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  label { font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
  input, select, button { background:#0b1224; color:var(--fg); border:1px solid #243042; border-radius:10px; padding:10px 12px; }
  input::placeholder { color:#64748b; }
  button { cursor:pointer; }
  .btn.primary { background:linear-gradient(180deg,#2563EB,#1D4ED8); border:none; padding:10px 14px; border-radius:10px; }
  .btn.danger { background:#7f1d1d; border:none; padding:10px 14px; border-radius:10px; }
  .grid { display:grid; gap:8px; grid-template-columns: repeat(7, 1fr); margin-top:12px; }
  .grid .cell { padding:8px 10px; background:#0b1224; border:1px solid #1f2937; border-radius:10px; text-align:center; }
  code.k { background:#0b1224; padding:2px 6px; border-radius:6px; border:1px solid #1f2937; }
  table { width:100%; border-collapse:collapse; margin-top:16px; }
  th, td { border-bottom:1px solid #1f2937; padding:8px; font-variant-numeric: tabular-nums; text-align:left; }
  th { background:#0b1224; color:#cbd5e1; }
</style>
</head>
<body>
<header>
  <h1>J1939 CAN ID → PGN Converter
    <small>Decode 29-bit CAN IDs into J1939 fields</small>
  </h1>
</header>

<main>
  <section class="card">
    <h3>Decode CAN ID</h3>
    <div class="controls">
      <select id="base">
        <option value="hex" selected>HEX</option>
        <option value="dec">DEC</option>
      </select>
      <input id="canid" placeholder="e.g. 0CF004FE or 219002879" style="flex:1" />
      <button class="btn primary" id="decode">Decode</button>
    </div>
    <div class="grid">
      <div class="cell"><label>P</label><div id="outP">—</div></div>
      <div class="cell"><label>R</label><div id="outR">—</div></div>
      <div class="cell"><label>DP</label><div id="outDP">—</div></div>
      <div class="cell"><label>PF</label><div id="outPF">—</div></div>
      <div class="cell"><label>PS</label><div id="outPS">—</div></div>
      <div class="cell"><label>SA</label><div id="outSA">—</div></div>
      <div class="cell"><label>PGN</label><div id="outPGN">—</div></div>
    </div>
  </section>

  <section class="card">
    <div class="controls" style="justify-content:space-between">
      <h3 style="margin:0">Decoded Rows</h3>
      <button class="btn danger" id="clearTable">Clear Table</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>CAN ID</th><th>P</th><th>R</th><th>DP</th><th>PF</th><th>PS</th><th>SA</th><th>PGN</th><th>Label</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </section>
</main>

<script>
const toInt = (v) => {
  if (!v) return NaN;
  v = String(v).trim();
  if (/^0x/i.test(v)) return parseInt(v,16);
  if (/^[0-9]+$/.test(v)) return parseInt(v,10);
  return parseInt(v,16);
};
const hex2 = (n) => (n>>>0).toString(16).toUpperCase().padStart(2,'0');
const hex8 = (n) => (n>>>0).toString(16).toUpperCase().padStart(8,'0');
const PGN_LABELS = {
  0xF004:"Electronic Engine Controller 1",
  0xFDA1:"Aftertreatment 1 Fuel Control 1",
  0xF111:"Gaseous Fuel Pressure 3",
  0xFE6C:"Tachograph",
  0xFFA2:"Proprietary B",
  0xEB00:"ISO Transport Protocol, Data Transfer"
};

function decode29(canId){
  const id=canId>>>0;
  const prio=(id>>>26)&0x7;
  const R=(id>>>25)&1;
  const DP=(id>>>24)&1;
  const PF=(id>>>16)&0xFF;
  const PS=(id>>>8)&0xFF;
  const SA=id&0xFF;
  let PGN;
  if(PF<240) PGN=(DP<<16)|(PF<<8);
  else PGN=(DP<<16)|(PF<<8)|PS;
  return{prio,R,DP,PF,PS,SA,PGN};
}

function toHex(val,pad=2){return (val>>>0).toString(16).toUpperCase().padStart(pad,'0');}

function addRow(o){
  const tbody=document.querySelector("#body");
  const tr=document.createElement("tr");
  tr.innerHTML=`<td><code class=k>${hex8(o.canid)}</code></td><td>${o.prio}</td><td>${o.R}</td><td>${toHex(o.DP)}</td><td>${toHex(o.PF)}</td><td>${toHex(o.PS)}</td><td>${toHex(o.SA)}</td><td>${toHex(o.PGN,4)}</td><td>${PGN_LABELS[o.PGN]||''}</td>`;
  tbody.prepend(tr);
}

document.querySelector("#decode").addEventListener("click",()=>{
  const raw=document.querySelector("#canid").value.trim();
  const id=toInt(raw);
  if(Number.isNaN(id)){alert("Invalid CAN ID");return;}
  const d=decode29(id);
  document.querySelector("#outP").textContent=d.prio;
  document.querySelector("#outR").textContent=d.R;
  document.querySelector("#outDP").textContent=toHex(d.DP);
  document.querySelector("#outPF").textContent=toHex(d.PF);
  document.querySelector("#outPS").textContent=toHex(d.PS);
  document.querySelector("#outSA").textContent=toHex(d.SA);
  document.querySelector("#outPGN").textContent=toHex(d.PGN,4);
  addRow({canid:id,...d});
});

// Clear table button
const tbody=document.querySelector("#body");
document.querySelector("#clearTable").addEventListener("click",()=>{tbody.innerHTML="";});

// preload sample
[0x0CF004FE,0x18FDA101,0x18F111FE].forEach(id=>{const d=decode29(id);addRow({canid:id,...d});});
</script>
</body>
</html>
