<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TLE9180 CRC3 Generator / Checker (32‑bit SPI)</title>
  <style>
    :root{--bg:#0b1020;--panel:#121930;--ink:#e6ecff;--muted:#9fb0ff33;--accent:#7aa2ff;--good:#32d296;--bad:#ff6b6b}
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;color:var(--ink);background:radial-gradient(1200px 600px at 80% -10%,#1a2350 0%,#0b1020 60%)}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px}
    .card{background:linear-gradient(180deg,#121933 0%,#0f152b 100%);border:1px solid #2b3562;border-radius:16px;padding:16px;box-shadow:0 10px 30px #00000040}
    .grid{display:grid;gap:14px}
    @media(min-width:880px){.grid{grid-template-columns:1.2fr 1fr}}
    label{display:block;font-size:12px;opacity:.85;margin-bottom:6px}
    input[type="number"],input[type="text"],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #35407a;background:#0b1230;color:var(--ink)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .row>.col{grid-column:span 3}
    .row>.col-2{grid-column:span 2}
    .row>.col-4{grid-column:span 4}
    .btn{cursor:pointer;user-select:none;display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid #3a4aa3;background:linear-gradient(180deg,#22306a,#1a2557);color:#e8eeff;font-weight:600}
    .btn:active{transform:translateY(1px)}
    .btn.alt{border-color:#36508c;background:linear-gradient(180deg,#18224d,#121a3a)}
    .btn.good{border-color:#2b7a5e;background:linear-gradient(180deg,#23684e,#1a4f3b)}
    .btn.bad{border-color:#8a2f2f;background:linear-gradient(180deg,#512020,#3a1717)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #3a4aa3;background:#0c1540aa;font-variant-numeric:tabular-nums}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{opacity:.8}
    .hl{color:var(--accent)}
    .out{display:grid;gap:8px}
    .box{padding:10px 12px;border-radius:10px;border:1px dashed #36508c;background:#0b1230}
    .bits{display:flex;flex-wrap:wrap;gap:6px}
    .b{padding:6px 8px;border-radius:8px;border:1px solid #30408a;background:#10194a;min-width:34px;text-align:center}
    .b.small{min-width:22px;padding:4px 6px}
    .b.good{border-color:#2f9d72;background:#0f2a23}
    .b.bad{border-color:#a64545;background:#2a0f0f}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;align-items:center}
    footer{margin-top:18px;opacity:.75}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TLE9180 CRC3 Generator / Checker (32‑bit SPI)</h1>
    <p class="muted">Polynomial <span class="pill mono">x³ + x + 1</span> (binary <span class="mono">1011</span>), seed <span class="mono">'101'</span> → start value <span class="mono">0b100</span>. CRC is calculated over <strong>bits 3..31</strong> (CRC excluded), default <strong>LSB‑first</strong>.</p>

    <div class="grid">
      <!-- Left: Builder -->
      <section class="card">
        <h2 style="margin:0 0 10px">Build TX Frame & Compute CRC</h2>
        <div class="row" style="margin-top:8px">
          <div class="col-4">
            <label>DATA (8‑bit, 0x00–0xFF)</label>
            <input id="inData" type="text" placeholder="e.g. 0x81 or 129" value="0x81" />
          </div>
          <div class="col-4">
            <label>ADDRESS (7‑bit, 0x00–0x7F)</label>
            <input id="inAddr" type="text" placeholder="e.g. 0x01 or 1" value="0x01" />
          </div>
          <div class="col-2">
            <label>Control C (bit)</label>
            <select id="inC">
              <option value="0">0 (Write)</option>
              <option value="1" selected>1 (Read)</option>
            </select>
          </div>
          <div class="col-2">
            <label>Bit order</label>
            <select id="inOrder">
              <option value="lsb" selected>LSB‑first</option>
              <option value="msb">MSB‑first</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" id="btnBuild">Compute & Build Frame</button>
          <button class="btn alt" id="btnExample">Load Example</button>
        </div>
        <div class="out" style="margin-top:14px">
          <div class="kv">
            <div>CRC3 result</div>
            <div class="mono" id="outCrc">—</div>
            <div>Frame (HEX)</div>
            <div class="mono" id="outHex">—</div>
            <div>Frame (BIN)</div>
            <div class="box mono" id="outBin">—</div>
          </div>
          <div>
            <div class="muted" style="margin:8px 0 6px">Bit fields (LSB on left, bit 0 first):</div>
            <div class="bits" id="fieldBar"></div>
          </div>
        </div>
      </section>

      <!-- Right: Checker -->
      <section class="card">
        <h2 style="margin:0 0 10px">Check RX Frame</h2>
        <label>Paste full 32‑bit frame (hex like <span class="mono">0xAABBCCDD</span> or decimal)</label>
        <input id="inFrameHex" type="text" placeholder="0xAABBCCDD" />
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" id="btnCheck">Check CRC</button>
          <button class="btn alt" id="btnClear">Clear</button>
        </div>
        <div class="out" style="margin-top:14px">
          <div class="kv">
            <div>CRC (in frame)</div>
            <div class="mono" id="rxCrcIn">—</div>
            <div>CRC (recomputed)</div>
            <div class="mono" id="rxCrcCalc">—</div>
            <div>Status</div>
            <div id="rxStatus">—</div>
          </div>
          <div class="box mono" id="rxBin">—</div>
        </div>
      </section>
    </div>

    <footer>
      <span class="muted">Layout (LSB→MSB):</span>
      <span class="pill mono">[0..2] CRC</span>
      <span class="pill mono">[3..7] Reserved</span>
      <span class="pill mono">[8..15] DATA</span>
      <span class="pill mono">[16..22] ADDRESS</span>
      <span class="pill mono">[23] C</span>
      <span class="pill mono">[24..31] Unused</span>
    </footer>
  </div>

<script>
  // ------- Helpers -------
  function parseNum(s){
    if(typeof s !== 'string') return 0;
    s = s.trim();
    if(!s) return 0;
    if(/^0x/i.test(s)) return Number.parseInt(s,16)>>>0;
    if(/^0b/i.test(s)) return Number.parseInt(s.slice(2),2)>>>0;
    return Number.parseInt(s,10)>>>0;
  }
  function toHex32(x){return '0x'+(x>>>0).toString(16).padStart(8,'0').toUpperCase()}
  function toBin32(x){return (x>>>0).toString(2).padStart(32,'0')}

  // ------- CRC engines -------
  // Polynomial x^3 + x + 1  (binary 1011). Start value = 0b100
  function crc3_lsb_first(frame_wo_crc){
    let r2=1,r1=0,r0=0; // start 0b100
    for(let i=3;i<=31;i++){
      const bit=(frame_wo_crc>>>i)&1;
      const fb = bit ^ r0;   // feedback
      const nr0 = r1 ^ fb;   // tap at x^1
      const nr1 = r2;
      const nr2 = fb;        // tap at x^3
      r0=nr0; r1=nr1; r2=nr2;
    }
    return ((r2<<2)|(r1<<1)|r0) & 0x7;
  }
  // Optional MSB-first (for comparison/testing only)
  function crc3_msb_first(frame_wo_crc){
    let r2=1,r1=0,r0=0; // 0b100
    for(let i=31;i>=3;i--){
      const bit=(frame_wo_crc>>>i)&1;
      const fb = bit ^ r2;   // when MSB-first, tap at highest reg bit
      const nr2 = r1;
      const nr1 = r0 ^ fb;   // tap at x^1
      const nr0 = fb;        // tap at x^3
      r0=nr0; r1=nr1; r2=nr2;
    }
    return ((r2<<2)|(r1<<1)|r0) & 0x7;
  }

  function buildFrame(data, addr, cbit){
    let f=0>>>0;
    f |= (data & 0xFF) << 8;     // DATA [8..15]
    f |= (addr & 0x7F) << 16;    // ADDRESS [16..22]
    f |= (cbit & 0x1) << 23;     // C [23]
    return f>>>0; // CRC bits [0..2] left 0 for now
  }

  function computeCRC(frame_wo_crc, order){
    return order==='msb' ? crc3_msb_first(frame_wo_crc) : crc3_lsb_first(frame_wo_crc);
  }

  // ------- UI wiring -------
  const inData = document.getElementById('inData');
  const inAddr = document.getElementById('inAddr');
  const inC    = document.getElementById('inC');
  const inOrder= document.getElementById('inOrder');

  const outCrc = document.getElementById('outCrc');
  const outHex = document.getElementById('outHex');
  const outBin = document.getElementById('outBin');
  const fieldBar = document.getElementById('fieldBar');

  const inFrameHex = document.getElementById('inFrameHex');
  const rxCrcIn = document.getElementById('rxCrcIn');
  const rxCrcCalc = document.getElementById('rxCrcCalc');
  const rxStatus = document.getElementById('rxStatus');
  const rxBin = document.getElementById('rxBin');

  function renderFieldBar(frame){
    fieldBar.innerHTML='';
    // show first 24 bits compact (0..23) and then group remaining
    for(let i=0;i<24;i++){
      const val=(frame>>>i)&1; const el=document.createElement('div');
      el.className='b small'; el.textContent=val; el.title='bit '+i;
      if(i<=2) el.style.outline='1px solid #5b74ff'; // CRC
      if(i>=3&&i<=7) el.style.outline='1px solid #4e5e9a'; // res
      if(i>=8&&i<=15) el.style.outline='1px solid #6b8cff'; // data
      if(i>=16&&i<=22) el.style.outline='1px solid #9bb0ff'; // addr
      if(i===23) el.style.outline='1px solid #42d6a4'; // C
      fieldBar.appendChild(el);
    }
    const more=document.createElement('div');
    more.className='b'; more.textContent='[24..31]'; more.title='unused 8 bits';
    fieldBar.appendChild(more);
  }

  function computeAndShow(){
    const d=parseNum(inData.value)&0xFF;
    const a=parseNum(inAddr.value)&0x7F;
    const c=parseNum(inC.value)&1;
    const order=inOrder.value;

    let base=buildFrame(d,a,c); // CRC cleared
    const crc=computeCRC(base, order);
    const frame=(base | crc)>>>0;

    outCrc.textContent=`bin ${crc.toString(2).padStart(3,'0')}  |  dec ${crc}  |  hex 0x${crc.toString(16).toUpperCase()}`;
    outHex.textContent=toHex32(frame);
    outBin.textContent=toBin32(frame);
    renderFieldBar(frame);
  }

  function checkFrame(){
    const x=parseNum(inFrameHex.value)>>>0;
    if(!Number.isFinite(x)){return}
    const crcIn = x & 0x7;
    const withoutCrc = x & ~0x7;
    const order=inOrder.value;
    const crcCalc=computeCRC(withoutCrc, order);
    rxCrcIn.textContent = '0b'+crcIn.toString(2).padStart(3,'0')+`  (dec ${crcIn})`;
    rxCrcCalc.textContent='0b'+crcCalc.toString(2).padStart(3,'0')+`  (dec ${crcCalc})`;
    const ok = (crcIn===crcCalc);
    rxStatus.innerHTML = ok
      ? `<span class="pill" style="border-color:#2f9d72;background:#0f2a23">OK ✓</span>`
      : `<span class="pill" style="border-color:#a64545;background:#2a0f0f">CRC Mismatch ✗ — discard & retry</span>`;
    rxBin.textContent = toBin32(x);
  }

  document.getElementById('btnBuild').addEventListener('click', computeAndShow);
  document.getElementById('btnExample').addEventListener('click', ()=>{
    inData.value='0x81'; inAddr.value='0x01'; inC.value='1'; inOrder.value='lsb'; computeAndShow();
  });
  document.getElementById('btnCheck').addEventListener('click', checkFrame);
  document.getElementById('btnClear').addEventListener('click', ()=>{
    inFrameHex.value=''; rxCrcIn.textContent='—'; rxCrcCalc.textContent='—'; rxStatus.textContent='—'; rxBin.textContent='—';
  });

  // initial compute (with defaults)
  computeAndShow();
</script>
</body>
</html>
