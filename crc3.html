<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TLE9180 CRC3 Calculator • 24‑bit SPI TX (bits 23..0)</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#121a33;--muted:#93a4c5;--fg:#e7edff;--accent:#7aa2ff;--ok:#30d158;--bad:#ff453a;--chip:#1f2a4d;
      --mono:"Fira Code",ui-monospace,Menlo,Consolas,monospace;--sans:Inter,system-ui,Segoe UI,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0d1430 40%,#0b1020);color:var(--fg);font-family:var(--sans);}
    header{padding:22px 16px 8px;text-align:center}
    h1{margin:0;font-size:22px;font-weight:700;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    main{max-width:1100px;margin:16px auto;padding:0 16px 40px;display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .card{background:var(--panel);border:1px solid #1e2a4f;border-radius:14px;box-shadow:0 10px 30px #0006;}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1e2a4f;font-size:15px;font-weight:700;letter-spacing:.2px}
    .content{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    input,select,button,textarea{border-radius:10px;border:1px solid #2a3a6a;background:#0f1733;color:var(--fg);padding:10px;font-family:var(--mono);font-size:14px}
    input::placeholder{color:#6f86bf}
    button{cursor:pointer;background:linear-gradient(180deg,#273b74,#1e2e61);border:1px solid #2f4aa1}
    button:hover{filter:brightness(1.05)}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap}
    .mono{font-family:var(--mono);font-size:13.5px}
    .bits{display:flex;flex-wrap:wrap;gap:4px}
    .bit{background:var(--chip);border:1px solid #2b3a6b;border-radius:8px;padding:6px 8px;display:flex;flex-direction:column;align-items:center;gap:4px;min-width:70px}
    .bit .t{font-size:11px;color:var(--muted)}
    .bit .v{font-family:var(--mono);font-size:14px}
    .out{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .k{color:var(--muted);font-size:12px}
    .good{color:var(--ok)}
    .bad{color:var(--bad)}
    .small{font-size:12px;color:var(--muted)}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{border-bottom:1px solid #243465;padding:8px 6px;font-size:13px;text-align:left}
    .tbl th{color:#c9d6ff;font-weight:600}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2f4aa1;background:#0e1a3a;font-size:11px;color:#cfe0ff}
    .footer{padding:8px 14px;color:var(--muted);font-size:12px}
    @media (max-width:900px){main{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <h1>TLE9180 CRC3 Calculator</h1>
  <div class="sub">24‑bit SPI TX frame • Compute CRC over bits <b>23..3</b> • Poly <span class="mono">x^3 + x + 1</span> • Seed “101” ⇒ start <span class="mono">100</span> • MSB‑first</div>
</header>
<main>
  <section class="card">
    <h2>Input</h2>
    <div class="content">
      <div class="row" style="margin-bottom:10px">
        <div>
          <label>CONTROL C (bit 23) — 0:Write, 1:Read</label>
          <select id="c"><option value="0">0 (Write)</option><option value="1" selected>1 (Read)</option></select>
        </div>
        <div>
          <label>ADDRESS [22:16] (7‑bit, hex)</label>
          <input id="addr" placeholder="01" value="01" />
        </div>
        <div>
          <label>DATA [15:8] (8‑bit, hex)</label>
          <input id="data" placeholder="81" value="81" />
        </div>
      </div>
      <div class="btn-row" style="margin-bottom:12px">
        <button id="compute">Compute CRC</button>
        <button id="clear">Clear</button>
        <span class="pill">Reserved [7..3] = 0</span>
        <span class="pill">CRC field [2..0] excluded from calculation</span>
      </div>
      <div class="bits" id="bits"></div>
      <div class="out" style="margin-top:12px">
        <div>
          <div class="k">CRC (MSB‑first over 23..3)</div>
          <div class="mono" id="crcHex">0x?</div>
          <div class="small" id="crcBin">(bin)</div>
        </div>
        <div>
          <div class="k">Packed 24‑bit word (CRC inserted)</div>
          <div class="mono" id="wordHex">0x????????</div>
          <div class="small" id="wordBin">(bin)</div>
        </div>
      </div>
    </div>
    <div class="footer">Tip: Type hex without 0x. Values clamp to valid bit‑widths.</div>
  </section>

  <section class="card">
    <h2>Verify against your table</h2>
    <div class="content">
      <div class="btn-row" style="margin-bottom:8px">
        <button id="runTable">Run test on all entries</button>
      </div>
      <table class="tbl" id="resultTable">
        <thead>
          <tr><th>#</th><th>C</th><th>ADDR</th><th>DATA</th><th>Given CRC</th><th>Computed</th><th>Match</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  // --- CRC3: polynomial x^3 + x + 1 ; seed "101" => start value 0b100 ; MSB-first over bits 23..3
  function crc3_tle9180(frame_wo_crc24){
    let lfsr = 0b100; // start value
    for(let i=23;i>=3;--i){
      const bit = (frame_wo_crc24 >>> i) & 1;
      const fb = bit ^ ((lfsr >>> 2) & 1); // xor with MSB tap (x^3)
      const b2 = (lfsr >>> 1) & 1;
      const b1 = (lfsr & 1) ^ fb; // tap at x^1
      const b0 = fb;              // tap at x^0
      lfsr = (b2<<2) | (b1<<1) | b0;
    }
    return lfsr & 0x7;
  }

  function pack24_wo_crc(c, addr, data){
    c    &= 0x1;
    addr &= 0x7F;
    data &= 0xFF;
    return (c<<23) | (addr<<16) | (data<<8); // [7..3]=0, [2..0]=CRC
  }

  function toHex(v, width=2){
    return '0x'+(v>>>0).toString(16).toUpperCase().padStart(width,'0');
  }
  function toBin(v, width){
    return (v>>>0).toString(2).padStart(width,'0');
  }

  function renderBits(c, addr, data, crc){
    const el = document.getElementById('bits');
    const pieces = [
      {t:'C [23]', v: c & 1},
      {t:'ADDR [22:16]', v: toHex(addr,2)+` ("${toBin(addr,7)}")`},
      {t:'DATA [15:8]', v: toHex(data,2)+` ("${toBin(data,8)}")`},
      {t:'RES [7:3]', v: toBin(0,5)},
      {t:'CRC [2:0]', v: toBin(crc,3)}
    ];
    el.innerHTML = pieces.map(p=>`<div class="bit"><div class="t">${p.t}</div><div class="v">${p.v}</div></div>`).join('');
  }

  function computeOnce(){
    let c = parseInt(document.getElementById('c').value,10) || 0;
    let addr = parseInt(document.getElementById('addr').value || '0', 16) || 0;
    let data = parseInt(document.getElementById('data').value || '0', 16) || 0;

    const base = pack24_wo_crc(c, addr, data);
    const crc = crc3_tle9180(base);
    const word = base | crc; // insert CRC into [2:0]

    renderBits(c, addr, data, crc);

    document.getElementById('crcHex').textContent = toHex(crc,1);
    document.getElementById('crcBin').textContent = toBin(crc,3);

    document.getElementById('wordHex').textContent = toHex(word,6);
    document.getElementById('wordBin').textContent = toBin(word,24).replace(/(.{4})/g,'$1 ').trim();
  }

  document.getElementById('compute').addEventListener('click', computeOnce);
  document.getElementById('clear').addEventListener('click', ()=>{
    document.getElementById('c').value = '1';
    document.getElementById('addr').value = '';
    document.getElementById('data').value = '';
    document.getElementById('bits').innerHTML = '';
    document.getElementById('crcHex').textContent = '0x?';
    document.getElementById('crcBin').textContent = '(bin)';
    document.getElementById('wordHex').textContent = '0x????????';
    document.getElementById('wordBin').textContent = '(bin)';
  });

  // ---- Verification against the provided table ----
  const table = [
    {C:1, A:0x01, D:0x81, CRC:0x4},
    {C:1, A:0x02, D:0x0F, CRC:0x0},
    {C:1, A:0x06, D:0x70, CRC:0x6},
    {C:1, A:0x07, D:0x9A, CRC:0x6},
    {C:1, A:0x08, D:0x32, CRC:0x1},
    {C:1, A:0x0A, D:0x2A, CRC:0x3},
    {C:1, A:0x0B, D:0x4A, CRC:0x3},
    {C:1, A:0x13, D:0x2A, CRC:0x5},
    {C:1, A:0x00, D:0xAC, CRC:0x2},
    {C:1, A:0x20, D:0x44, CRC:0x3},
    {C:1, A:0x21, D:0x44, CRC:0x7},
    {C:1, A:0x22, D:0x44, CRC:0x0},
    {C:1, A:0x23, D:0x9F, CRC:0x0}
  ];

  document.getElementById('runTable').addEventListener('click', ()=>{
    const tbody = document.querySelector('#resultTable tbody');
    tbody.innerHTML='';
    table.forEach((e,idx)=>{
      const base = pack24_wo_crc(e.C, e.A, e.D);
      const crc = crc3_tle9180(base);
      const ok = (crc & 7) === (e.CRC & 7);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx}</td>
        <td>${e.C}</td>
        <td>0x${e.A.toString(16).toUpperCase().padStart(2,'0')}</td>
        <td>0x${e.D.toString(16).toUpperCase().padStart(2,'0')}</td>
        <td>0x${(e.CRC&7).toString(16).toUpperCase()}</td>
        <td>0x${crc.toString(16).toUpperCase()}</td>
        <td class="${ok?'good':'bad'}">${ok?'PASS':'FAIL'}</td>`;
      tbody.appendChild(tr);
    });
  });

  // Auto-compute once on load for the default values
  computeOnce();
</script>
</body>
</html>
