<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Function Plotter + I/Q + QAM + Animation</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background-color: #f0f0f0;
    }
    #plot, #iqPlot, #polarIQ {
      width: 100%;
      height: 600px;
    }
    input, button, select, label {
      font-size: 1rem;
      margin: 0.5rem 0;
    }
    .controls {
      display: flex;
      flex-direction: column;
      max-width: 700px;
    }
  </style>
</head>
<body>
  <h1>RF Function Visualizer: I/Q + QAM + Animation + Noise</h1>

  <div class="controls">
    <label for="presetSelect">Choose a preset:</label>
    <select id="presetSelect" onchange="setPresetFunction()">
      <option value="Math.sin(2 * Math.PI * (x - shiftT)) * Math.cos(2 * Math.PI * freq * y)">Time-Shifted Sin * Cos</option>
      <option value="Math.exp(-Math.pow(x - shiftT, 2)) * Math.sin(2 * Math.PI * freq * y)">Shifted Gaussian Modulated Sine</option>
      <option value="(1 + 0.5 * Math.cos(2 * Math.PI * y / 10)) * Math.cos(2 * Math.PI * (x - shiftT))">Shifted AM Signal</option>
    </select>

    <label for="functionInput">Or enter custom function z = f(x, y):</label>
    <input type="text" id="functionInput" value="Math.sin(2 * Math.PI * (x - shiftT)) * Math.cos(2 * Math.PI * freq * y)" style="width: 100%;">

    <label for="shiftT">Time Shift (shiftT): <span id="shiftTLabel">0</span></label>
    <input type="range" id="shiftT" min="-10" max="10" step="0.1" value="0" oninput="updateLabel('shiftT')">

    <label for="freq">Frequency (freq): <span id="freqLabel">1</span></label>
    <input type="range" id="freq" min="0" max="10" step="0.1" value="1" oninput="updateLabel('freq')">

    <label for="noise">Noise Strength (0â€“1): <span id="noiseLabel">0</span></label>
    <input type="range" id="noise" min="0" max="1" step="0.05" value="0" oninput="updateLabel('noise')">

    <button onclick="drawPlot()">Draw 3D Surface</button>
    <button onclick="drawIQPlot()">Draw I/Q Constellation</button>
    <button onclick="drawPolarPlot()">Draw Polar I/Q</button>
    <button onclick="drawQAMSymbols()">Draw QAM Symbols</button>
    <button onclick="toggleAnimation()">Toggle Animation</button>
  </div>

  <div id="plot"></div>
  <h2>I/Q Constellation</h2>
  <div id="iqPlot"></div>
  <h2>Polar I/Q Plot</h2>
  <div id="polarIQ"></div>

  <script>
    let animationActive = false;
    let animationInterval;

    function setPresetFunction() {
      const select = document.getElementById("presetSelect");
      document.getElementById("functionInput").value = select.value;
    }

    function updateLabel(id) {
      const val = document.getElementById(id).value;
      document.getElementById(id + "Label").textContent = val;
    }

    function drawPlot() {
      const funcStr = document.getElementById("functionInput").value;
      const shiftT = parseFloat(document.getElementById("shiftT").value);
      const freq = parseFloat(document.getElementById("freq").value);
      const xRange = numeric.linspace(-10, 10, 50);
      const yRange = numeric.linspace(-10, 10, 50);
      let zData = [];

      for (let i = 0; i < xRange.length; i++) {
        let zRow = [];
        for (let j = 0; j < yRange.length; j++) {
          const x = xRange[i];
          const y = yRange[j];
          try {
            const z = eval(funcStr);
            zRow.push(z);
          } catch (e) {
            zRow.push(0);
          }
        }
        zData.push(zRow);
      }

      Plotly.newPlot('plot', [{ z: zData, x: xRange, y: yRange, type: 'surface' }]);
    }

    function drawIQPlot() {
      const shiftT = parseFloat(document.getElementById("shiftT").value);
      const freq = parseFloat(document.getElementById("freq").value);
      const noise = parseFloat(document.getElementById("noise").value);
      const t = numeric.linspace(-2 * Math.PI, 2 * Math.PI, 100);
      let I = [], Q = [];

      for (let i = 0; i < t.length; i++) {
        const tt = t[i];
        const nI = noise * (Math.random() - 0.5);
        const nQ = noise * (Math.random() - 0.5);
        I.push(Math.cos(freq * (tt - shiftT)) + nI);
        Q.push(Math.sin(freq * (tt - shiftT)) + nQ);
      }

      const trace = {
        x: I,
        y: Q,
        mode: 'lines+markers',
        name: 'I/Q Trace',
        type: 'scatter',
        marker: { size: 4 },
        line: { shape: 'spline' }
      };

      Plotly.newPlot('iqPlot', [trace], {
        title: 'I/Q Constellation with Noise',
        xaxis: { title: 'In-Phase (I)' },
        yaxis: { title: 'Quadrature (Q)' },
        width: 600,
        height: 600
      });
    }

    function drawPolarPlot() {
      const shiftT = parseFloat(document.getElementById("shiftT").value);
      const freq = parseFloat(document.getElementById("freq").value);
      const noise = parseFloat(document.getElementById("noise").value);
      const t = numeric.linspace(0, 2 * Math.PI, 100);
      let r = [], theta = [];

      for (let i = 0; i < t.length; i++) {
        const tt = t[i];
        const I = Math.cos(freq * (tt - shiftT)) + noise * (Math.random() - 0.5);
        const Q = Math.sin(freq * (tt - shiftT)) + noise * (Math.random() - 0.5);
        r.push(Math.sqrt(I * I + Q * Q));
        theta.push(Math.atan2(Q, I));
      }

      Plotly.newPlot('polarIQ', [{
        type: 'scatterpolar',
        r: r,
        theta: theta.map(v => v * 180 / Math.PI),
        mode: 'lines+markers'
      }], {
        polar: {
          radialaxis: { visible: true },
          angularaxis: { direction: 'clockwise' }
        },
        title: 'Polar I/Q with Noise'
      });
    }

    function drawQAMSymbols() {
      const symbols = [
        [-3, -3], [-3, -1], [-3, 1], [-3, 3],
        [-1, -3], [-1, -1], [-1, 1], [-1, 3],
        [1, -3], [1, -1], [1, 1], [1, 3],
        [3, -3], [3, -1], [3, 1], [3, 3]
      ];

      const decisionRegions = symbols.map(([i, q]) => ({
        type: 'circle',
        xref: 'x',
        yref: 'y',
        x0: i - 0.5, x1: i + 0.5,
        y0: q - 0.5, y1: q + 0.5,
        line: { color: 'rgba(0,0,255,0.2)', width: 1 },
        fillcolor: 'rgba(0,0,255,0.05)',
        layer: 'below'
      }));

      const trace = {
        x: symbols.map(s => s[0]),
        y: symbols.map(s => s[1]),
        mode: 'markers+text',
        text: symbols.map((s, i) => `S${i}`),
        textposition: 'top center',
        type: 'scatter',
        marker: { size: 10, color: 'red' },
        name: '16-QAM'
      };

      Plotly.newPlot('iqPlot', [trace], {
        title: '16-QAM with Decision Regions',
        xaxis: { title: 'I' },
        yaxis: { title: 'Q' },
        width: 600,
        height: 600,
        shapes: decisionRegions
      });
    }

    function toggleAnimation() {
      animationActive = !animationActive;
      if (animationActive) {
        animationInterval = setInterval(() => {
          const slider = document.getElementById("shiftT");
          let value = parseFloat(slider.value);
          value = value >= 10 ? -10 : value + 0.1;
          slider.value = value.toFixed(2);
          updateLabel("shiftT");
          drawIQPlot();
          drawPolarPlot();
        }, 100);
      } else {
        clearInterval(animationInterval);
      }
    }

    drawPlot();
    drawIQPlot();
    drawPolarPlot();
  </script>
</body>
</html>
