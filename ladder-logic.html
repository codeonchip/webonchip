<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ladder Logic — Mini Editor & Simulator</title>
<style>
  :root{
    --bg:#0c1020; --panel:#121838; --panel2:#0e1430; --rail:#7aa2ff; --wire:#8fb3ff; --text:#eaf4ff; --muted:#a8c7ff; --accent:#6ea2ff; --danger:#ff6b6b; --ok:#62d391;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 50% -10%, #131b46, var(--bg));color:var(--text);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .wrap{display:grid;grid-template-columns:280px minmax(720px,1fr) 320px;gap:14px;padding:14px}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #24317a;border-radius:14px;box-shadow:0 10px 24px #0008}
  .panel h2{margin:10px 12px 6px 12px;font-size:16px;letter-spacing:.2px;color:var(--muted)}
  .palette,.right{padding:10px}
  .btn{background:#0b1338;border:1px solid var(--accent);padding:6px 10px;border-radius:10px;color:var(--text);font-weight:700;cursor:pointer;margin:4px 4px 6px 0}
  .btn:active{transform:translateY(1px)}
  .btn-danger{border-color:var(--danger);color:#ffd7d7}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  .grid{position:relative; padding:10px}
  canvas{display:block;background:#000;border-radius:14px;border:2px solid #2944a2;box-shadow:inset 0 0 40px #000, 0 20px 40px #000a;width:100%;height:auto}
  label{display:block;margin:6px 0 2px}
  input[type="number"],select,input[type="text"]{width:100%;background:#0b1338;border:1px solid #3854b6;color:var(--text);border-radius:8px;padding:6px 8px}
  .io{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .chip{background:#0b1338;border:1px solid #2b3f9b;border-radius:10px;padding:6px 8px;text-align:center}
  .chip input{accent-color:#86b7ff}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px;align-items:center}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel palette">
    <h2>Palette</h2>
    <div class="row">
      <button class="btn" data-tool="NO">NO Contact</button>
      <button class="btn" data-tool="NC">NC Contact</button>
      <button class="btn" data-tool="COIL">Coil</button>
      <button class="btn" data-tool="TON">TON Timer</button>
      <button class="btn" data-tool="WIRE">Wire</button>
      <button class="btn btn-danger" id="erase">Erase</button>
    </div>
    <div class="row small">Click a cell to place. Select an element to edit its tag/params.</div>

    <h2>Project</h2>
    <div class="row">
      <button class="btn" id="newRung">+ Rung</button>
      <button class="btn" id="clear">Clear</button>
      <button class="btn" id="export">Export</button>
      <button class="btn" id="import">Import</button>
    </div>

    <h2>Selected element</h2>
    <div id="inspector" class="small">Nothing selected</div>
  </div>

  <div class="panel">
    <h2 style="display:flex;align-items:center;justify-content:space-between;margin:10px 12px 0 12px">
      <span>Ladder (mini)
      <span class="small">— series logic, simple TON</span></span>
      <span>
        <button class="btn" id="run">▶ Run</button>
        <button class="btn" id="stop">⏸ Stop</button>
      </span>
    </h2>
    <div class="grid"><canvas id="ladder" width="1100" height="620" aria-label="Ladder grid"></canvas></div>
    <div class="row" style="padding:8px 12px 12px 12px">
      <div class="small">Scan time: <span id="scanMs">0</span> ms • Rungs: <span id="rCount">0</span></div>
    </div>
  </div>

  <div class="panel right">
    <h2>IO & Memory</h2>
    <div class="small">Toggle inputs (I0..I7), watch internal bits (M) and outputs (Q).</div>
    <label>Inputs</label>
    <div id="inputs" class="io"></div>
    <label>Internals (M)</label>
    <div id="mem" class="io"></div>
    <label>Outputs</label>
    <div id="outs" class="io"></div>

    <h2>Examples</h2>
    <div class="row">
      <button class="btn" id="exSeal">Seal‑in Motor</button>
      <button class="btn" id="exTON">TON Delay</button>
    </div>

    <h2>Notes</h2>
    <div class="small">This is a compact educational simulator. It supports series contacts per rung and simple TON timers. Parallel branches are not yet supported (use multiple rungs and internal bits to emulate OR logic). Preset time is in milliseconds.</div>
  </div>
</div>

<script>
// --- Model -----------------------------------------------------------------
const COLS=18, ROWS=12; // visible grid cells per rung row
const CELL_W=56, CELL_H=44; // drawing sizes
const LEFT_RAIL_X=40, RIGHT_RAIL_X=LEFT_RAIL_X + COLS*CELL_W + 40;
const RUNG_V_SP=CELL_H+10;

let rungs=[]; // each rung: {cells: Array(COLS).fill(null)} (single row)
let timers=[]; // runtime TON states
let running=false; let last=0; let scanMs=0;

const IO={ I:Array(8).fill(false), Q:Array(8).fill(false), M:Array(16).fill(false) };

const canvas=document.getElementById('ladder');
const ctx=canvas.getContext('2d');
const rCountEl=document.getElementById('rCount');
const scanEl=document.getElementById('scanMs');
const inspector=document.getElementById('inspector');

function newRung(){ rungs.push({cells:Array(COLS).fill(null)}); layout(); }
function clearAll(){ rungs=[]; timers=[]; layout(); }

// element shape: {type:'NO'|'NC'|'COIL'|'TON'|'WIRE', tag:'I0/M0/Q0', params:{pt:1000}, id}
let tool='NO';
let selected=null; // {r,c}

// --- UI: palette & IO ------------------------------------------------------
document.querySelectorAll('[data-tool]').forEach(b=>b.addEventListener('click',()=>tool=b.dataset.tool));
document.getElementById('erase').onclick=()=>tool='ERASE';
document.getElementById('newRung').onclick=newRung;
document.getElementById('clear').onclick=()=>{ if(confirm('Clear project?')) clearAll(); };
document.getElementById('run').onclick=()=>{ running=true; };
document.getElementById('stop').onclick=()=>{ running=false; };

// Export/Import
function serialize(){ return JSON.stringify({ rungs, timers:[], IO }, null, 2); }
function deserialize(text){ const o=JSON.parse(text); rungs=o.rungs||[]; timers=[]; Object.assign(IO, o.IO||{}); layout(); buildIO(); }
document.getElementById('export').onclick=()=>{ const blob=new Blob([serialize()],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ladder.json'; a.click(); };
document.getElementById('import').onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>deserialize(r.result); r.readAsText(f); }; inp.click(); };

function buildIO(){
  const inputs=document.getElementById('inputs'); const mem=document.getElementById('mem'); const outs=document.getElementById('outs');
  function mk(container, arr, prefix, writable){
    container.innerHTML='';
    arr.forEach((v,i)=>{
      const d=document.createElement('div'); d.className='chip';
      const id=`${prefix}${i}`;
      d.innerHTML=`<label class="mono"><input type="checkbox" ${v?'checked':''} ${writable? '' : 'disabled'} data-id="${id}"> ${id}</label>`;
      container.appendChild(d);
    });
    container.querySelectorAll('input').forEach(ch=>{
      ch.onchange=()=>{
        const id=ch.dataset.id; const i=parseInt(id.slice(1)); const p=id[0];
        if(p==='I') IO.I[i]=ch.checked; if(p==='M') IO.M[i]=ch.checked; if(p==='Q') IO.Q[i]=ch.checked;
      };
    });
  }
  mk(inputs, IO.I, 'I', true);
  mk(mem, IO.M, 'M', true); // allow user to force M for testing
  mk(outs, IO.Q, 'Q', false);
}
buildIO();

// --- Drawing ---------------------------------------------------------------
function layout(){
  canvas.height = Math.max(620, rungs.length*RUNG_V_SP + 80);
  rCountEl.textContent = rungs.length;
  draw();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // background
  ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height);

  // rails
  ctx.strokeStyle=getCSS('--rail'); ctx.lineWidth=4;
  ctx.beginPath(); ctx.moveTo(LEFT_RAIL_X, 30); ctx.lineTo(LEFT_RAIL_X, canvas.height-30); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(RIGHT_RAIL_X, 30); ctx.lineTo(RIGHT_RAIL_X, canvas.height-30); ctx.stroke();

  // rungs
  ctx.font='12px ui-monospace,Consolas';
  rungs.forEach((r,i)=>{
    const y = 50 + i*RUNG_V_SP;
    // base wire from left
    ctx.strokeStyle=getCSS('--wire'); ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(LEFT_RAIL_X, y); ctx.lineTo(LEFT_RAIL_X+COLS*CELL_W, y); ctx.stroke();

    // cells
    r.cells.forEach((cell,c)=>{ if(!cell) return; drawCell(cell, c, y); });

    // selection box
    if(selected && selected.r===i){ ctx.strokeStyle='rgba(255,216,0,0.35)'; ctx.setLineDash([5,5]); ctx.strokeRect(LEFT_RAIL_X+selected.c*CELL_W, y-CELL_H/2, CELL_W, CELL_H); ctx.setLineDash([]); }

    // labels
    ctx.fillStyle='#a8c7ff'; ctx.fillText(`Rung ${i+1}`, LEFT_RAIL_X-32, y-18);
  });

  // outputs mirror
  updateOutputsUI();
}

function drawCell(cell, col, y){
  const x = LEFT_RAIL_X + col*CELL_W + CELL_W/2; // center
  ctx.save();
  ctx.translate(x, y);
  ctx.strokeStyle=getCSS('--wire'); ctx.fillStyle=getCSS('--wire'); ctx.lineWidth=2;
  // type
  if(cell.type==='NO' || cell.type==='NC'){
    // contact symbol
    ctx.beginPath();
    ctx.moveTo(-CELL_W/2+6, 0); ctx.lineTo(-12, 0);
    ctx.moveTo(12,0); ctx.lineTo(CELL_W/2-6,0);
    ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-6,-14); ctx.lineTo(-6,14); ctx.moveTo(6,-14); ctx.lineTo(6,14); ctx.stroke();
    if(cell.type==='NC'){ ctx.beginPath(); ctx.moveTo(-10,-14); ctx.lineTo(10,14); ctx.strokeStyle='#ffb3b3'; ctx.stroke(); }
    // tag
    drawTag(cell);
  } else if(cell.type==='COIL'){
    ctx.beginPath(); ctx.arc(-8,0,12,0,Math.PI*2); ctx.arc(8,0,12,0,Math.PI*2); ctx.stroke();
    drawTag(cell);
  } else if(cell.type==='TON'){
    // block
    ctx.strokeStyle=getCSS('--wire');
    ctx.strokeRect(-CELL_W/2+6,-16,CELL_W-12,32);
    ctx.fillStyle='#a8c7ff'; ctx.fillText('TON', -8, -2);
    ctx.fillText(`PT:${(cell.params?.pt||1000)}ms`, -CELL_W/2+12, 18);
    ctx.fillStyle=getCSS('--wire');
  } else if(cell.type==='WIRE'){
    ctx.beginPath(); ctx.moveTo(-CELL_W/2+6,0); ctx.lineTo(CELL_W/2-6,0); ctx.stroke();
  }
  ctx.restore();
}
function drawTag(cell){
  ctx.save(); ctx.fillStyle='#cfe1ff'; ctx.textAlign='center'; ctx.font='12px ui-monospace,Consolas';
  ctx.fillText(cell.tag||'', 0, -18); ctx.restore();
}
function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v); }

// --- Hit testing & placement ----------------------------------------------
canvas.addEventListener('click', (e)=>{
  const p = canvas.getBoundingClientRect();
  const cx = e.clientX - p.left, cy = e.clientY - p.top;
  const r = Math.round((cy-50)/RUNG_V_SP);
  if(r<0 || r>=rungs.length) { selected=null; draw(); showInspector(); return; }
  const y = 50 + r*RUNG_V_SP;
  const c = Math.floor((cx - LEFT_RAIL_X) / CELL_W);
  if(c<0 || c>=COLS) { selected=null; draw(); showInspector(); return; }
  selected = {r, c};
  if(tool==='ERASE'){ rungs[r].cells[c] = null; draw(); showInspector(); return; }
  if(tool){
    const id = crypto.randomUUID();
    if(tool==='NO' || tool==='NC' || tool==='COIL') rungs[r].cells[c] = {type:tool, tag:'', id};
    else if(tool==='TON') rungs[r].cells[c] = {type:'TON', tag:'T'+(timers.length), params:{pt:1000}, id};
    else if(tool==='WIRE') rungs[r].cells[c] = {type:'WIRE', id};
  }
  draw(); showInspector();
});

function showInspector(){
  if(!selected){ inspector.textContent='Nothing selected'; return; }
  const cell = rungs[selected.r].cells[selected.c];
  if(!cell){ inspector.textContent='Empty cell'; return; }
  let html = `<div class="kv"><div>Type</div><div class="mono">${cell.type}</div>`;
  if(cell.type==='NO'||cell.type==='NC'||cell.type==='COIL'){
    html += `<div>Tag</div><div><input id="tagIn" type="text" placeholder="I0, M0, Q0" value="${cell.tag||''}"></div>`;
  }
  if(cell.type==='TON'){
    html += `<div>Tag (Q)</div><div><input id="tagIn" type="text" placeholder="T0 (for display)" value="${cell.tag||''}"></div>`;
    html += `<div>Preset (ms)</div><div><input id="ptIn" type="number" min="10" step="10" value="${cell.params?.pt||1000}"></div>`;
  }
  html += `</div>`;
  inspector.innerHTML = html;
  const tagIn=document.getElementById('tagIn'); if(tagIn) tagIn.oninput=()=>{ cell.tag=tagIn.value.trim(); draw(); };
  const ptIn=document.getElementById('ptIn'); if(ptIn) ptIn.oninput=()=>{ cell.params.pt = Math.max(10, +ptIn.value||1000); };
}

// --- Simulation ------------------------------------------------------------
function evalTag(tag){
  tag = (tag||'').toUpperCase();
  if(/^I\d+$/.test(tag)) return IO.I[+tag.slice(1)]||false;
  if(/^M\d+$/.test(tag)) return IO.M[+tag.slice(1)]||false;
  if(/^Q\d+$/.test(tag)) return IO.Q[+tag.slice(1)]||false;
  return false;
}

function setTag(tag,val){
  tag = (tag||'').toUpperCase();
  if(/^M\d+$/.test(tag)) IO.M[+tag.slice(1)] = !!val;
  if(/^Q\d+$/.test(tag)) IO.Q[+tag.slice(1)] = !!val;
}

function getTimerState(id){ let t=timers.find(x=>x.id===id); if(!t){ t={id,acc:0,on:false,prevIn:false}; timers.push(t);} return t; }

function simulate(dt){
  const t0=performance.now();
  // scan rungs in order
  rungs.forEach(r=>{
    // compute power flow left->right through series cells
    let power = true; // left rail is powered
    r.cells.forEach(cell=>{
      if(!cell) return; if(!power) return; // once power is false, rest of series is deenergized
      if(cell.type==='NO'){ power = evalTag(cell.tag); }
      else if(cell.type==='NC'){ power = !evalTag(cell.tag); }
      else if(cell.type==='TON'){
        const st = getTimerState(cell.id);
        const IN = power; // TON is in series; power is its input
        if(IN){ st.acc = Math.min(st.acc + dt*1000, cell.params.pt||1000); }
        else { st.acc = 0; }
        st.on = st.acc >= (cell.params.pt||1000);
        power = st.on; // Q output in series path
      }
      else if(cell.type==='WIRE'){ power = power; }
      else if(cell.type==='COIL'){ setTag(cell.tag, power); }
    });
  });
  scanMs = Math.round(performance.now()-t0);
}

function updateOutputsUI(){
  // refresh Q mirror
  const outs=document.getElementById('outs');
  outs.querySelectorAll('input').forEach((ch,i)=>{ ch.checked = !!IO.Q[i]; });
}

// --- Examples --------------------------------------------------------------
function loadSeal(){
  clearAll(); newRung(); newRung();
  // Rung1: I0 (start) NO, M0 (seal) NO -> Q0 coil
  rungs[0].cells[1]={type:'NO',tag:'I0'};
  rungs[0].cells[2]={type:'NO',tag:'M0'};
  rungs[0].cells[5]={type:'COIL',tag:'Q0'};
  // Rung2: Q0 NO -> M0 coil (self-hold)
  rungs[1].cells[1]={type:'NO',tag:'Q0'};
  rungs[1].cells[4]={type:'COIL',tag:'M0'};
  layout(); draw();
}
function loadTON(){
  clearAll(); newRung();
  // Rung1: I1 NO -> TON(PT=2000) -> Q1
  rungs[0].cells[1]={type:'NO',tag:'I1'};
  rungs[0].cells[3]={type:'TON',tag:'T0',params:{pt:2000},id:crypto.randomUUID()};
  rungs[0].cells[6]={type:'COIL',tag:'Q1'};
  layout(); draw();
}
document.getElementById('exSeal').onclick=loadSeal;
document.getElementById('exTON').onclick=loadTON;

// --- Main loop -------------------------------------------------------------
function tick(t){
  requestAnimationFrame(tick);
  const now=t/1000; const dt=Math.min(0.033, (now-last)||0); last=now;
  if(running){ simulate(dt); }
  draw(); scanEl.textContent=scanMs;
}

// helpers
function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name); }

// boot
newRung();
draw();
requestAnimationFrame(tick);
</script>
</body>
</html>
