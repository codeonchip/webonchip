<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Concave (Hemispherical) Sundial — Hour Lines • Seasonal Lines • Horizontal Base</title>
  <style>
    :root{
      --bg:#f7f7fb; --fg:#111; --muted:#6b7280; --accent:#0f766e; --rim:#1f2937;
      --hour:#0b4f9c; --season:#b45309; --eq:#065f46; --summer:#9a3412; --winter:#1d4ed8;
      --grid:#e5e7eb; --base:#d1d5db;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--fg);background:var(--bg)}
    header{padding:16px 20px;border-bottom:1px solid var(--grid);background:white;position:sticky;top:0;z-index:1}
    h1{font-size:20px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px}
    main{display:grid;grid-template-columns:360px 1fr;gap:16px;max-width:1200px;margin:18px auto;padding:0 16px}
    .card{background:white;border:1px solid var(--grid);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .panel{padding:16px}
    .controls label{display:block;margin:10px 0 4px;color:#374151;font-weight:600}
    .row{display:flex;gap:10px;align-items:center}
    input[type="range"]{width:100%}
    .legend{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .legend .item{display:flex;align-items:center;gap:8px;font-size:13px;color:#374151}
    .sw{width:14px;height:14px;border-radius:3px;border:1px solid #0002}
    canvas{width:100%;height:auto;display:block}
    .foot{padding:10px 16px;color:var(--muted);font-size:12px}
    .btn{appearance:none;border:1px solid var(--grid);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .row.wrap{flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <h1>Concave (Hemispherical) Sundial</h1>
    <div class="sub">Interactive bowl dial (à la <em>angbu-ilgu</em>): hour lines, seasonal lines (solstices & equinox), and a horizontal base. Change latitude & radius to explore.</div>
  </header>

  <main>
    <section class="card panel controls">
      <label for="lat">Latitude (°): <span id="latVal">37.5</span></label>
      <input id="lat" type="range" min="-75" max="75" step="0.1" value="37.5" />

      <label for="radius">Bowl Radius (px): <span id="rVal">250</span></label>
      <input id="radius" type="range" min="120" max="320" step="1" value="250" />

      <div class="row wrap" style="margin-top:10px">
        <label class="row" style="gap:8px"><input id="lblHours" type="checkbox" checked /> Show hour labels</label>
        <label class="row" style="gap:8px"><input id="lblSeason" type="checkbox" checked /> Show season labels</label>
        <label class="row" style="gap:8px"><input id="clipDay" type="checkbox" checked /> Clip to daytime (sun above horizon)</label>
      </div>

      <div class="legend">
        <div class="item"><span class="sw" style="background:var(--rim)"></span> Bowl rim</div>
        <div class="item"><span class="sw" style="background:var(--base)"></span> Horizontal base</div>
        <div class="item"><span class="sw" style="background:var(--hour)"></span> Hour lines</div>
        <div class="item"><span class="sw" style="background:var(--eq)"></span> Equinox (δ=0°)</div>
        <div class="item"><span class="sw" style="background:var(--summer)"></span> Summer solstice (δ=+23.44°)</div>
        <div class="item"><span class="sw" style="background:var(--winter)"></span> Winter solstice (δ=−23.44°)</div>
      </div>

      <div class="row" style="margin-top:12px;gap:8px">
        <button class="btn" id="export">Export PNG</button>
        <button class="btn" id="reset">Reset</button>
      </div>

      <div class="foot">Axes: x→East, y→North. We look straight down on the bowl (the lower hemisphere, z≤0). Lines are loci of shadow points on the inner surface.
      </div>
    </section>

    <section class="card">
      <canvas id="dial" width="900" height="700" aria-label="Hemispherical sundial drawing"></canvas>
    </section>
  </main>

  <script>
    // --- Math helpers ---
    const DEG = Math.PI/180;
    function sunVector(latDeg, decDeg, Hdeg){
      const phi = latDeg*DEG, d = decDeg*DEG, H = Hdeg*DEG;
      // Local topocentric components: x=East, y=North, z=Up
      const x = Math.cos(d)*Math.sin(H);
      const y = Math.cos(phi)*Math.sin(d) - Math.sin(phi)*Math.cos(d)*Math.cos(H);
      const z = Math.sin(phi)*Math.sin(d) + Math.cos(phi)*Math.cos(d)*Math.cos(H);
      return {x,y,z}; // unit vector
    }

    function draw(){
      const lat = parseFloat(latInp.value);
      const R = parseFloat(rInp.value);
      latVal.textContent = lat.toFixed(1);
      rVal.textContent = R.toFixed(0);

      const w = canvas.width, h = canvas.height;
      const cx = w*0.52, cy = h*0.58; // center on canvas
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,w,h);

      // Horizontal base (a soft shadow rectangle beneath the bowl)
      ctx.save();
      ctx.fillStyle = getCSS('--base');
      const baseW = R*2.4, baseH = 16;
      ctx.fillRect(cx-baseW/2, cy+R+14, baseW, baseH);
      ctx.restore();

      // Bowl rim
      ctx.save();
      ctx.lineWidth = 2;
      ctx.strokeStyle = getCSS('--rim');
      ctx.beginPath();
      ctx.arc(cx, cy, R, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();

      // Clip to inside the bowl (circle) so curves don't spill out
      ctx.save();
      ctx.beginPath();
      ctx.arc(cx, cy, R, 0, Math.PI*2);
      ctx.clip();

      // Subtle grid (latitude circles within bowl for visual aid)
      ctx.strokeStyle = '#00000010';
      ctx.lineWidth = 1;
      for(let k=1;k<=3;k++){
        ctx.beginPath();
        ctx.arc(cx, cy, (R*k/3), 0, Math.PI*2);
        ctx.stroke();
      }

      // Draw seasonal lines (declination curves)
      const seasonSpecs = [
        {dec: +23.44, color: getCSS('--summer'), label:'Summer solstice'},
        {dec: 0.00,   color: getCSS('--eq'),     label:'Equinox'},
        {dec: -23.44, color: getCSS('--winter'), label:'Winter solstice'}
      ];

      const clipDay = clipDayInp.checked;

      for(const s of seasonSpecs){
        drawSeasonCurve(ctx, cx, cy, R, lat, s.dec, s.color, clipDay);
        if(lblSeasonInp.checked){ placeSeasonLabel(ctx, cx, cy, R, lat, s.dec, s.color, s.label); }
      }

      // Draw hour lines: H from -6h..+6h (i.e., -90°…+90° hour angle)
      ctx.lineWidth = 1.5;
      for(let hour=-6; hour<=6; hour++){
        const Hdeg = hour*15; // degrees
        drawHourCurve(ctx, cx, cy, R, lat, Hdeg, getCSS('--hour'), clipDay);
        if(lblHoursInp.checked){
          placeHourLabel(ctx, cx, cy, R, lat, Hdeg, hour);
        }
      }

      ctx.restore(); // end clip

      // Cardinal marks on the rim
      drawCardinals(ctx, cx, cy, R);

      // Title
      ctx.save();
      ctx.fillStyle = '#111';
      ctx.font = '600 14px system-ui,Segoe UI,Roboto';
      ctx.textAlign = 'center';
      ctx.fillText(`Latitude ${lat.toFixed(1)}°`, cx, cy - R - 14);
      ctx.restore();

      // Utility: export
      document.getElementById('export').onclick = () => {
        const link = document.createElement('a');
        link.download = `hemisphere_sundial_lat${lat.toFixed(1)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      };

      document.getElementById('reset').onclick = () => {
        latInp.value = 37.5; rInp.value = 250;
        lblHoursInp.checked = true; lblSeasonInp.checked = true; clipDayInp.checked = true;
        draw();
      };

      // --- helpers
      function drawSeasonCurve(ctx, cx, cy, R, lat, dec, color, clipDay){
        ctx.save();
        ctx.strokeStyle = color; ctx.lineWidth = 2;
        ctx.beginPath();
        let started=false;
        for(let H=-180; H<=180; H+=0.5){
          const s = sunVector(lat, dec, H);
          const sunUp = s.z > 0; // sun above horizon
          if(clipDay && !sunUp){ continue; }
          const p = {x: -R*s.x, y: -R*s.y, z: -R*s.z}; // shadow point on bowl (lower hemisphere)
          if(p.z>1e-6){ continue; } // keep lower hemisphere (z<=0)
          const X = cx + p.x, Y = cy + p.y;
          if(!started){ ctx.moveTo(X,Y); started=true; }
          else{ ctx.lineTo(X,Y); }
        }
        ctx.stroke();
        ctx.restore();
      }

      function drawHourCurve(ctx, cx, cy, R, lat, Hdeg, color, clipDay){
        ctx.save();
        ctx.strokeStyle = color; ctx.setLineDash([]);
        ctx.beginPath();
        let started=false, lastKept=false;
        for(let dec=-23.44; dec<=23.44; dec+=0.2){
          const s = sunVector(lat, dec, Hdeg);
          const sunUp = s.z>0;
          if(clipDay && !sunUp){ lastKept=false; continue; }
          const p = {x:-R*s.x, y:-R*s.y, z:-R*s.z};
          if(p.z>1e-6){ lastKept=false; continue; }
          const X = cx+p.x, Y = cy+p.y;
          if(!started){ ctx.moveTo(X,Y); started=true; lastKept=true; }
          else{
            if(!lastKept){ ctx.moveTo(X,Y); lastKept=true; }
            else ctx.lineTo(X,Y);
          }
        }
        ctx.lineWidth = 1.25;
        ctx.stroke();
        ctx.restore();
      }

      function placeHourLabel(ctx, cx, cy, R, lat, Hdeg, hour){
        // Pick declination near 0 to estimate a readable label position on the curve
        const s = sunVector(lat, 0, Hdeg);
        const p = {x:-R*s.x, y:-R*s.y, z:-R*s.z};
        if(p.z>0) return;
        const X = cx+p.x, Y = cy+p.y;
        ctx.save();
        ctx.fillStyle = '#0b4f9c';
        ctx.font = '600 12px system-ui,Segoe UI,Roboto';
        ctx.textAlign = 'center';
        const label = ((hour+24)%24).toString().padStart(2,'0')+':00';
        ctx.fillText(label, X, Y-2);
        ctx.restore();
      }

      function placeSeasonLabel(ctx, cx, cy, R, lat, dec, color, label){
        // Place label near H = -90° (morning) where the curve is usually distinct
        const s = sunVector(lat, dec, -90);
        const p = {x:-R*s.x, y:-R*s.y, z:-R*s.z};
        if(p.z>0) return;
        const X = cx+p.x, Y = cy+p.y;
        ctx.save();
        ctx.fillStyle = color; ctx.font='600 12px system-ui,Segoe UI,Roboto';
        ctx.textAlign='right';
        ctx.fillText(label, X-6, Y-4);
        ctx.restore();
      }

      function drawCardinals(ctx, cx, cy, R){
        ctx.save();
        ctx.strokeStyle = '#0008'; ctx.lineWidth = 1; ctx.setLineDash([5,6]);
        // North-South
        ctx.beginPath(); ctx.moveTo(cx, cy-R-8); ctx.lineTo(cx, cy+R+8); ctx.stroke();
        // East-West
        ctx.beginPath(); ctx.moveTo(cx-R-8, cy); ctx.lineTo(cx+R+8, cy); ctx.stroke();

        // Rim ticks
        const ticks = [
          {ang:0, lbl:'E'}, {ang:90, lbl:'N'}, {ang:180, lbl:'W'}, {ang:270, lbl:'S'}
        ];
        ctx.fillStyle='#111'; ctx.font='700 12px system-ui,Segoe UI,Roboto'; ctx.textAlign='center';
        for(const t of ticks){
          const a = t.ang*DEG; const x = cx + (R+10)*Math.cos(a); const y = cy + (R+10)*Math.sin(a);
          ctx.fillText(t.lbl, x, y+4);
        }
        ctx.restore();
      }

      function getCSS(varName){
        return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
      }
    }

    // DOM wiring
    const canvas = document.getElementById('dial');
    const latInp = document.getElementById('lat');
    const rInp = document.getElementById('radius');
    const latVal = document.getElementById('latVal');
    const rVal = document.getElementById('rVal');
    const lblHoursInp = document.getElementById('lblHours');
    const lblSeasonInp = document.getElementById('lblSeason');
    const clipDayInp = document.getElementById('clipDay');

    [latInp, rInp, lblHoursInp, lblSeasonInp, clipDayInp].forEach(el=>{
      el.addEventListener('input', draw);
      el.addEventListener('change', draw);
    });

    // Initial render
    draw();
  </script>
</body>
</html>
