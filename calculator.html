import React, { useEffect, useMemo, useRef, useState } from "react";

// Printing Calculator (paper-tape style)
// - Two-column monospace tape
// - Add/Subtract/Multiply/Divide
// - Subtotal, Total (=), Grand Total memory (GT)
// - Tax+ / Tax- using configurable tax rate
// - Percent % based on accumulator (classic printing calc behavior)
// - Rounding: 5/4, UP, DOWN with fixed decimal selector: F, 0, 2, 3, 4
// - Feed (blank line), Void (strike last), Date/Time print
// - Print/Copy/Export CSV controls
// - Keyboard: digits, ., + - * /, Enter (=), Backspace (←), Esc (AC)

// ---------- Utilities ----------
const DECIMAL_CHOICES = ["F", 0, 2, 3, 4] as const;
const ROUND_CHOICES = ["5/4", "UP", "DOWN"] as const;

function clampDecimals(decimals: typeof DECIMAL_CHOICES[number]): number | "F" {
  return decimals === "F" ? "F" : Math.max(0, Math.min(8, Number(decimals)));
}

function roundTo(num: number, decimals: number | "F", mode: typeof ROUND_CHOICES[number]): number {
  if (!isFinite(num)) return 0;
  if (decimals === "F") return num; // free (as entered)
  const f = Math.pow(10, decimals);
  const x = num * f;
  if (mode === "UP") return (num >= 0 ? Math.ceil(x) : Math.floor(x)) / f;
  if (mode === "DOWN") return (num >= 0 ? Math.floor(x) : Math.ceil(x)) / f;
  // 5/4 (half-up)
  return (Math.sign(x) * Math.round(Math.abs(x))) / f;
}

function formatAmount(num: number, decimals: number | "F"): string {
  if (!isFinite(num)) return "NaN";
  if (decimals === "F") {
    // Show up to 8 decimals, trim trailing zeros
    const s = num.toFixed(8);
    return s.replace(/\.?0+$/, "");
  }
  return num.toFixed(decimals);
}

function rightPad(str: string, len: number): string {
  return (str + " ".repeat(len)).slice(0, len);
}
function leftPad(str: string, len: number): string {
  if (str.length >= len) return str;
  return " ".repeat(len - str.length) + str;
}

// ---------- Types ----------
 type RoundMode = typeof ROUND_CHOICES[number];
 type DecSel = typeof DECIMAL_CHOICES[number];
 type Op = "+" | "-" | "×" | "÷" | null;
 type LineKind =
  | "entry" // printed numeric entry with operator tag
  | "subtotal"
  | "total"
  | "gt"
  | "tax"
  | "percent"
  | "feed"
  | "info"
  ;

 interface TapeLine {
  id: string;
  ts: number;
  kind: LineKind;
  text: string; // full rendered text
  rawAmount?: number; // for CSV/export
  voided?: boolean;
 }

// ---------- Component ----------
export default function PrintingCalculator() {
  // Calculator states
  const [entry, setEntry] = useState<string>("0");
  const [acc, setAcc] = useState<number | null>(null);
  const [lastOp, setLastOp] = useState<Op>(null);
  const [itemCount, setItemCount] = useState<number>(0);

  const [grandTotal, setGrandTotal] = useState<number>(0);
  const [gtEnabled, setGtEnabled] = useState<boolean>(true);

  const [decimals, setDecimals] = useState<DecSel>(2);
  const [roundMode, setRoundMode] = useState<RoundMode>("5/4");
  const [taxRate, setTaxRate] = useState<number>(8.25);

  const [tape, setTape] = useState<TapeLine[]>([]);
  const tapeEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    tapeEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [tape.length]);

  const display = useMemo(() => entry, [entry]);

  // Helpers
  const parsedEntry = () => {
    const n = Number(entry.replace(/,/g, ""));
    return isFinite(n) ? n : 0;
  };
  const pushTape = (line: Omit<TapeLine, "id" | "ts">) => {
    setTape((t) => [
      ...t,
      { id: crypto.randomUUID(), ts: Date.now(), ...line },
    ]);
  };

  const renderLine = (amount: number | null, rightTag: string, kind: LineKind) => {
    // 40-col style: left free text, right amount + tag
    const width = 40;
    const amtStr = amount !== null ? formatAmount(amount, decimals) : "";
    const right = (amtStr + (rightTag ? " " + rightTag : "")).trim();
    const left = ""; // no extra left text for now
    const text = leftPad(right, width);
    pushTape({ kind, text, rawAmount: amount ?? undefined });
  };

  // Core operations
  const commitEntry = (op: Op) => {
    const val = roundTo(parsedEntry(), decimals, roundMode);
    // print current entry with operator tag
    renderLine(val, op ?? "", "entry");
    setItemCount((c) => c + 1);

    if (acc === null) {
      setAcc(val);
    } else if (lastOp) {
      setAcc(applyOp(acc, val, lastOp));
    } else {
      // No pending op: replace acc
      setAcc(val);
    }
    setEntry("0");
    setLastOp(op);
  };

  const equalsTotal = () => {
    const hasNumber = entry !== "" && entry !== "-";
    let res = acc ?? 0;
    if (hasNumber && lastOp) {
      const val = roundTo(parsedEntry(), decimals, roundMode);
      renderLine(val, lastOp, "entry");
      setItemCount((c) => c + 1);
      res = applyOp(acc ?? 0, val, lastOp);
    }

    // Print total separator & total
    pushTape({ kind: "info", text: "-".repeat(40) });
    renderLine(res, "=", "total");

    if (gtEnabled) setGrandTotal((g) => roundTo(g + res, decimals, roundMode));

    // After total, keep result as new accumulator, clear entry/op
    setAcc(res);
    setEntry("0");
    setLastOp(null);
  };

  const subtotal = () => {
    const res = acc ?? 0;
    pushTape({ kind: "info", text: "-".repeat(40) });
    renderLine(res, "SUBT", "subtotal");
  };

  const applyPercent = () => {
    // Classic behavior: percent of accumulator
    const base = acc ?? 0;
    const val = roundTo((base * parsedEntry()) / 100, decimals, roundMode);
    renderLine(val, "%", "percent");
    setEntry(String(val));
  };

  const applyTax = (sign: 1 | -1) => {
    const base = parsedEntry();
    const amt = roundTo(base * (taxRate / 100) * sign, decimals, roundMode);
    const final = roundTo(base + amt, decimals, roundMode);
    const tag = sign > 0 ? "TX+" : "TX-";
    const label = `${formatAmount(base, decimals)}  ${tag} ${taxRate}%`;
    // Show tax line then resulting adjusted entry line
    const width = 40;
    pushTape({ kind: "tax", text: leftPad(label, width), rawAmount: final });
    renderLine(final, tag, "tax");
    setEntry(String(final));
  };

  const grandTotalPrint = () => {
    pushTape({ kind: "info", text: "=".repeat(40) });
    renderLine(grandTotal, "GT", "gt");
  };

  // Ops
  function applyOp(a: number, b: number, op: Op): number {
    switch (op) {
      case "+":
        return roundTo(a + b, decimals, roundMode);
      case "-":
        return roundTo(a - b, decimals, roundMode);
      case "×":
        return roundTo(a * b, decimals, roundMode);
      case "÷":
        return roundTo(b === 0 ? NaN : a / b, decimals, roundMode);
      default:
        return b;
    }
  }

  // Entry editing
  const append = (ch: string) => {
    setEntry((e) => {
      if (e === "0" && ch !== ".") return ch;
      if (e === "-0" && ch !== ".") return "-" + ch;
      if (ch === "." && e.includes(".")) return e;
      return e + ch;
    });
  };

  const backspace = () => {
    setEntry((e) => {
      if (e.length <= 1 || e === "-0") return "0";
      const s = e.slice(0, -1);
      if (s === "" || s === "-") return "0";
      return s;
    });
  };

  const toggleSign = () => {
    setEntry((e) => {
      if (e.startsWith("-")) return e.slice(1) || "0";
      if (e === "0") return "-0";
      return "-" + e;
    });
  };

  const clearEntry = () => setEntry("0");
  const allClear = () => {
    setEntry("0");
    setAcc(null);
    setLastOp(null);
    setItemCount(0);
    setTape([]);
  };

  const feed = () => pushTape({ kind: "feed", text: "" });
  const voidLast = () => {
    setTape((t) => {
      for (let i = t.length - 1; i >= 0; i--) {
        if (!t[i].voided && t[i].kind !== "info" && t[i].text.trim() !== "") {
          const copy = [...t];
          const line = { ...copy[i] };
          line.voided = true;
          // visually strike-through using ~~ ~~ markers on print/export; rendered here with brackets
          line.text = markVoided(line.text);
          copy[i] = line;
          return copy;
        }
      }
      return t;
    });
  };

  function markVoided(s: string) {
    // Represent VOID with surrounding markers; keep monospace alignment
    if (s.includes("[VOID]")) return s;
    const trimmed = s.trimEnd();
    const pad = " ".repeat(Math.max(0, s.length - trimmed.length));
    return `[VOID] ${trimmed}${pad}`;
  }

  // Printing & export
  const printTape = () => {
    const html = `<!doctype html><html><head><meta charset="utf-8"/><title>Paper Tape</title>
      <style>
        body{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding:20px}
        pre{font-size:14px; line-height:1.3}
      </style>
    </head><body>
    <h2>Paper Tape</h2>
    <pre>${tape.map((l) => l.text || "").join("\n")}</pre>
    <script>window.onload = () => window.print();</script>
    </body></html>`;
    const w = window.open("", "_blank");
    if (w) {
      w.document.open();
      w.document.write(html);
      w.document.close();
    }
  };

  const copyTape = async () => {
    const txt = tape.map((l) => l.text).join("\n");
    try {
      await navigator.clipboard.writeText(txt);
      alert("Tape copied to clipboard.");
    } catch (e) {
      alert("Copy failed. Your browser may block clipboard access.");
    }
  };

  const exportCSV = () => {
    const rows = [
      ["timestamp", "kind", "text", "rawAmount"],
      ...tape.map((l) => [new Date(l.ts).toISOString(), l.kind, l.text, l.rawAmount ?? ""]),
    ];
    const csv = rows.map((r) => r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `tape_${new Date().toISOString().replace(/[:.]/g, "-")}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // Keyboard support
  useEffect(() => {
    const onKey = (e: KeyboardEvent) => {
      const k = e.key;
      if (/^[0-9]$/.test(k)) { append(k); return; }
      if (k === ".") { append("."); return; }
      if (k === "+") { e.preventDefault(); commitEntry("+"); return; }
      if (k === "-") { e.preventDefault(); commitEntry("-"); return; }
      if (k === "*") { e.preventDefault(); commitEntry("×"); return; }
      if (k === "/") { e.preventDefault(); commitEntry("÷"); return; }
      if (k === "Enter" || k === "=") { e.preventDefault(); equalsTotal(); return; }
      if (k === "Backspace") { e.preventDefault(); backspace(); return; }
      if (k === "Escape") { e.preventDefault(); allClear(); return; }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [acc, lastOp, entry, decimals, roundMode]);

  // UI elements
  const Key = ({ label, onClick, wide = false, className = "" }: { label: string; onClick: () => void; wide?: boolean; className?: string; }) => (
    <button
      onClick={onClick}
      className={
        "text-base md:text-lg rounded-2xl shadow p-3 md:p-4 border bg-white hover:bg-gray-50 active:scale-[.99] transition w-full " +
        (wide ? " col-span-2 " : " ") + className
      }
    >
      {label}
    </button>
  );

  const numKey = (n: string) => <Key key={n} label={n} onClick={() => append(n)} />;

  return (
    <div className="min-h-screen w-full bg-gradient-to-br from-gray-50 to-gray-100 text-gray-900 p-4 md:p-8">
      <div className="mx-auto max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Tape */}
        <div className="bg-white rounded-2xl shadow-xl p-4 md:p-6 flex flex-col">
          <div className="flex items-center justify-between mb-3">
            <h1 className="text-xl md:text-2xl font-bold">Printing Calculator</h1>
            <div className="flex items-center gap-2">
              <label className="text-sm flex items-center gap-1">
                <input type="checkbox" className="accent-black" checked={gtEnabled} onChange={(e) => setGtEnabled(e.target.checked)} />
                GT Memory
              </label>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-3 mb-4">
            <div className="bg-gray-900 text-green-200 rounded-xl px-4 py-3 font-mono text-2xl text-right tabular-nums">
              {(() => {
                const n = Number(display);
                return isFinite(n) ? formatAmount(roundTo(n, decimals, roundMode), decimals) : display;
              })()}
            </div>
            <div className="bg-gray-100 rounded-xl px-4 py-3 font-mono text-sm flex items-center justify-between">
              <div>Items: <span className="font-semibold tabular-nums">{itemCount}</span></div>
              <div>GT: <span className="font-semibold tabular-nums">{formatAmount(grandTotal, decimals)}</span></div>
            </div>
          </div>

          <div className="flex-1 overflow-auto bg-[#f8f7f3] border rounded-xl p-3 font-mono text-sm leading-6">
            {tape.length === 0 && (
              <div className="text-gray-500">Paper tape will appear here…</div>
            )}
            {tape.map((l) => (
              <div key={l.id} className={"whitespace-pre tabular-nums " + (l.voided ? " line-through text-red-700 " : "")}>{l.text}</div>
            ))}
            <div ref={tapeEndRef} />
          </div>

          <div className="mt-3 flex flex-wrap gap-2">
            <button className="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50" onClick={printTape}>Print Tape</button>
            <button className="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50" onClick={copyTape}>Copy Tape</button>
            <button className="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50" onClick={exportCSV}>Export CSV</button>
            <button className="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50" onClick={feed}>Feed</button>
            <button className="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50" onClick={voidLast}>Void Last</button>
            <button className="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50" onClick={() => pushTape({ kind: "info", text: leftPad(new Date().toLocaleString(), 40) })}>Date/Time</button>
          </div>
        </div>

        {/* Keypad + Settings */}
        <div className="grid grid-rows-[auto_auto] gap-6">
          {/* Settings */}
          <div className="bg-white rounded-2xl shadow-xl p-4 md:p-6">
            <h2 className="text-lg font-semibold mb-4">Settings</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <div className="text-sm font-medium mb-1">Decimals</div>
                <div className="flex gap-2 flex-wrap">
                  {DECIMAL_CHOICES.map((d) => (
                    <label key={String(d)} className={"px-2 py-1 rounded-lg border cursor-pointer " + (decimals === d ? " bg-black text-white " : " bg-white ") }>
                      <input className="hidden" type="radio" name="dec" checked={decimals === d} onChange={() => setDecimals(d)} />
                      {String(d)}
                    </label>
                  ))}
                </div>
              </div>
              <div>
                <div className="text-sm font-medium mb-1">Rounding</div>
                <div className="flex gap-2 flex-wrap">
                  {ROUND_CHOICES.map((r) => (
                    <label key={r} className={"px-2 py-1 rounded-lg border cursor-pointer " + (roundMode === r ? " bg-black text-white " : " bg-white ") }>
                      <input className="hidden" type="radio" name="round" checked={roundMode === r} onChange={() => setRoundMode(r)} />
                      {r}
                    </label>
                  ))}
                </div>
              </div>
              <div>
                <label className="text-sm font-medium mb-1 block" htmlFor="tax">Tax Rate (%)</label>
                <input id="tax" type="number" step="0.01" value={taxRate}
                  onChange={(e) => setTaxRate(Number(e.target.value))}
                  className="w-full border rounded-lg px-3 py-2" />
              </div>
            </div>
          </div>

          {/* Keypad */}
          <div className="bg-white rounded-2xl shadow-xl p-4 md:p-6">
            <h2 className="text-lg font-semibold mb-3">Keypad</h2>
            <div className="grid grid-cols-4 gap-2 md:gap-3">
              <Key label="AC" className="bg-rose-600 text-white" onClick={allClear} />
              <Key label="C" onClick={clearEntry} />
              <Key label="±" onClick={toggleSign} />
              <Key label="%" onClick={applyPercent} />

              <Key label="7" onClick={() => append("7")} />
              <Key label="8" onClick={() => append("8")} />
              <Key label="9" onClick={() => append("9")} />
              <Key label="÷" className="bg-gray-900 text-white" onClick={() => commitEntry("÷")} />

              <Key label="4" onClick={() => append("4")} />
              <Key label="5" onClick={() => append("5")} />
              <Key label="6" onClick={() => append("6")} />
              <Key label="×" className="bg-gray-900 text-white" onClick={() => commitEntry("×")} />

              <Key label="1" onClick={() => append("1")} />
              <Key label="2" onClick={() => append("2")} />
              <Key label="3" onClick={() => append("3")} />
              <Key label="-" className="bg-gray-900 text-white" onClick={() => commitEntry("-\")} />

              <Key label="0" wide onClick={() => append("0")} />
              <Key label="." onClick={() => append(".")} />
              <Key label="+" className="bg-gray-900 text-white" onClick={() => commitEntry("+")} />

              <Key label="TAX+" onClick={() => applyTax(1)} />
              <Key label="TAX-" onClick={() => applyTax(-1)} />
              <Key label="SUBT" onClick={subtotal} />
              <Key label="=" className="bg-emerald-600 text-white" onClick={equalsTotal} />

              <Key label="GT" onClick={grandTotalPrint} />
              <Key label="←" onClick={backspace} />
              <Key label="FEED" onClick={feed} />
              <Key label="VOID" onClick={voidLast} />
            </div>
          </div>
        </div>
      </div>

      <footer className="mt-8 text-center text-xs text-gray-500">
        Tip: Use keyboard — numbers, ., + - * /, Enter (=), Backspace (←), Esc (AC)
      </footer>
    </div>
  );
}
